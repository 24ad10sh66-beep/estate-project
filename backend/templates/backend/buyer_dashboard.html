<!DOCTYPE html>
<html>
<head>
    <title>Buyer Dashboard - Estate Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Buyer Theme Colors */
            --primary-teal: #14b8a6;
            --primary-teal-dark: #0d9488;
            --secondary-teal-light: #2dd4bf;
            --secondary-cyan: #06b6d4;
            --accent-emerald: #10b981;
            --success-green: #22c55e;
            --warning-amber: #f59e0b;
            --error-red: #ef4444;
            
            /* Neutrals for both themes */
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
        }
        
        /* Dark Theme Variables (Default) */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.4);
        }
        
        /* Light Theme Variables */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5v rgb(0 0 0 / 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            overflow-x: hidden;
        }
        /* Top Navigation */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 2rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-brand img {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
        }
        
        .nav-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .search-box {
            position: relative;
            display: flex;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
        }
        
        .search-box input {
            background: var(--gray-50);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 0.875rem 1rem 0.875rem 3rem;
            width: 100%;
            font-size: 1rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-teal);
            box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.2), 0 4px 12px rgba(13, 148, 136, 0.3);
            transform: translateY(-2px);
        }
        
        .search-box input::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
            font-weight: 400;
        }
        
        .search-box i {
            position: absolute;
            left: 1rem;
            color: var(--text-secondary);
            font-size: 1.125rem;
            pointer-events: none;
            z-index: 1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .search-box:focus-within i {
            transform: scale(1.1);
            color: var(--primary-teal);
        }
        
        .notification-btn {
            position: relative;
            background: none;
            border: none;
            padding: 0.5rem;
            border-radius: 0.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .notification-btn:hover {
            background: var(--gray-100);
            color: var(--text-primary);
        }
        
        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: var(--primary-teal);
            color: white;
            border-radius: 50%;
            width: 0.5rem;
            height: 0.5rem;
        }
        
        .user-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background: var(--primary-teal);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            border: 2px solid var(--border-color);
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .user-avatar:hover {
            border-color: var(--primary-teal);
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-avatar i {
            color: white;
            font-size: 0.875rem;
        }
        
        .logout-btn {
            background: linear-gradient(135deg, var(--primary-teal) 0%, var(--secondary-cyan) 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logout-btn:hover {
            background: linear-gradient(135deg, var(--secondary-cyan) 0%, var(--primary-teal) 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            color: var(--text-secondary);
        }
        
        .theme-toggle:hover {
            background: var(--gray-100);
            color: var(--text-primary);
            border-color: var(--primary-teal);
        }
        
        [data-theme="light"] .theme-toggle:hover {
            background: var(--gray-700);
        }
        
        .theme-toggle i {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }
        
        .theme-toggle:hover i {
            transform: rotate(180deg);
        }
        /* Dashboard Layout */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* Featured Properties Section */
        .featured-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-title i {
            color: var(--primary-teal);
        }
        
        /* Property Card Styles */
        .property-mini-card {
            min-width: 200px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .property-mini-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-teal);
        }
        
        .property-image-container {
            width: 100%;
            height: 120px;
            overflow: hidden;
            background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-teal-dark) 100%);
            position: relative;
        }
        
        .property-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .property-mini-card:hover .property-image {
            transform: scale(1.1);
        }
        
        .property-image-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
        }
        
        .property-mini-info {
            padding: 1rem;
            text-align: center;
        }
        
        .property-mini-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .property-mini-details {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .property-mini-price {
            color: var(--primary-teal);
            font-weight: 600;
        }
        
        [data-theme="light"] .property-mini-card {
            background: #ffffff;
            border-color: #e2e8f0;
        }
        
        [data-theme="light"] .property-mini-title {
            color: #0f172a;
            font-weight: 700;
        }
        
        [data-theme="light"] .property-mini-details {
            color: #475569;
        }
        
        /* Quick Actions Grid */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .action-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
            display: block;
        }
        
        .action-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
            border-color: var(--primary-teal);
            text-decoration: none;
            color: inherit;
        }
        
        .action-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .action-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            background: var(--primary-teal);
        }
        
        .action-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .action-content p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: 0;
        }
        
        .action-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .action-btn {
            background: var(--primary-teal);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .action-btn:hover {
            background: var(--primary-teal-dark);
        }
        
        .action-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        /* Footer */
        .footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 2rem 0;
            margin-top: 4rem;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-container {
                padding: 1.5rem;
            }
            
            .actions-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .top-nav {
                padding: 0 1rem;
                flex-wrap: wrap;
                height: auto;
                min-height: 4rem;
            }
            
            .search-box {
                order: 3;
                width: 100%;
                margin-top: 1rem;
                min-width: 100%;
                max-width: 100%;
            }
            
            .search-box input {
                width: 100%;
                padding: 0.75rem 1rem 0.75rem 2.75rem;
                font-size: 0.9375rem;
            }
            
            .search-box i {
                left: 0.875rem;
                font-size: 1rem;
            }
            
            .dashboard-container {
                padding: 1rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
            
            .action-card,
            .featured-section {
                padding: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .nav-brand {
                gap: 0.5rem;
            }
            
            .nav-title {
                font-size: 1rem;
            }
            
            .nav-actions {
                gap: 0.5rem;
            }
            
            .user-avatar {
                width: 1.75rem;
                height: 1.75rem;
            }
            
            .logout-btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }
        }

        /* Animations for Saved Properties Modal */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        @keyframes shimmer {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Quick Search & Filter Styles */
        .price-preset, .type-chip {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .price-preset:hover, .type-chip:hover {
            border-color: #14b8a6;
            color: #14b8a6;
            transform: translateY(-2px);
        }

        .price-preset.active, .type-chip.active {
            background: linear-gradient(135deg, #14b8a6, #0d9488);
            border-color: #14b8a6;
            color: white;
        }

        .quick-search-property-card {
            transition: all 0.3s ease;
        }

        .quick-search-property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
            border-color: #14b8a6 !important;
        }

        /* Search input focus effect */
        .search-box input:focus {
            outline: none;
            border-color: #14b8a6;
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }

        /* Filter inputs focus */
        #minPrice:focus, #maxPrice:focus, #bedroomsFilter:focus, 
        #bathroomsFilter:focus, #sortBy:focus {
            outline: none;
            border-color: #14b8a6;
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }
    </style>
</head>
<body>
    <!-- Notification Panel -->
    {% include 'backend/notification_component.html' %}
    
    <!-- Modal Dialogs -->
    <!-- Saved Properties Modal -->
    <div id="savedPropertiesModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); margin: 2rem auto; padding: 0; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); width: 95%; max-width: 1200px; max-height: 85vh; display: flex; flex-direction: column; animation: slideDown 0.3s ease;">
            <!-- Modal Header -->
            <div style="padding: 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), rgba(13, 148, 136, 0.1));">
                <div>
                    <h2 style="margin: 0; font-size: 1.875rem; font-weight: 700; background: linear-gradient(135deg, #14b8a6, #0d9488); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-heart"></i> My Saved Properties
                    </h2>
                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">Properties you've bookmarked for later</p>
                </div>
                <button onclick="closeSavedPropertiesModal()" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.25rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div style="flex: 1; overflow-y: auto; padding: 2rem;">
                <div id="savedPropertiesLoading" style="display: none; text-align: center; padding: 3rem;">
                    <div style="width: 60px; height: 60px; border: 5px solid var(--border-color); border-top-color: #14b8a6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-secondary); font-size: 1.125rem; font-weight: 600;">Loading saved properties...</p>
                </div>
                <div id="savedPropertiesContent" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Payment History Modal -->
    <div id="paymentHistoryModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); margin: 2rem auto; padding: 0; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); width: 95%; max-width: 1200px; max-height: 85vh; display: flex; flex-direction: column; animation: slideDown 0.3s ease;">
            <!-- Modal Header -->
            <div style="padding: 2rem; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.875rem; font-weight: 700; background: linear-gradient(135deg, #10b981, #059669); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-money-check-alt"></i> Transaction History
                        </h2>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">View all your payment transactions</p>
                    </div>
                    <button onclick="closePaymentHistoryModal()" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.25rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Search Bar -->
                <div style="position: relative; margin-top: 1rem;">
                    <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.875rem;"></i>
                    <input type="text" id="txnSearchInput" placeholder="Search by Transaction ID (e.g., #12345)..." style="width: 100%; padding: 0.875rem 1rem 0.875rem 2.75rem; background: var(--input-bg); border: 2px solid var(--border-color); border-radius: 0.75rem; color: var(--text-primary); font-size: 0.875rem; transition: all 0.2s;" oninput="filterTransactions()" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                    <button onclick="clearTransactionSearch()" id="clearTxnSearch" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Search Info -->
                <div id="txnSearchInfo" style="margin-top: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; border-radius: 0.25rem; display: none;">
                    <p style="margin: 0; color: var(--text-primary); font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle" style="color: #10b981;"></i>
                        <span id="txnSearchInfoText"></span>
                    </p>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div style="flex: 1; overflow-y: auto; padding: 2rem;">
                <div id="paymentHistoryLoading" style="display: none; text-align: center; padding: 3rem;">
                    <div style="width: 60px; height: 60px; border: 5px solid var(--border-color); border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-secondary); font-size: 1.125rem; font-weight: 600;">Loading transaction history...</p>
                </div>
                <div id="paymentHistoryContent" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Market Insights Modal -->
    <div id="marketInsightsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); margin: 2rem auto; padding: 0; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); width: 95%; max-width: 1400px; max-height: 85vh; display: flex; flex-direction: column; animation: slideDown 0.3s ease;">
            <!-- Modal Header -->
            <div style="padding: 2rem; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1));">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.875rem; font-weight: 700; background: linear-gradient(135deg, #3b82f6, #2563eb); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-chart-line"></i> Market Insights & Trends
                        </h2>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">Real-time property market analytics and price trends</p>
                    </div>
                    <button onclick="closeMarketInsightsModal()" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.25rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Advanced Search & Filters -->
                <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem;">
                    <!-- Main Search Bar with Autocomplete -->
                    <div style="position: relative; margin-bottom: 1rem;">
                        <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.875rem;"></i>
                        <input type="text" id="marketSearchInput" placeholder="Search by location, property type, or keyword..." style="width: 100%; padding: 0.875rem 3rem 0.875rem 2.75rem; background: var(--input-bg); border: 2px solid var(--border-color); border-radius: 0.75rem; color: var(--text-primary); font-size: 0.875rem; transition: all 0.2s;" oninput="handleMarketSearch(event)" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="setTimeout(() => hideMarketSuggestions(), 200); this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                        <button onclick="clearMarketSearch()" id="clearMarketBtn" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <!-- Autocomplete Suggestions Dropdown -->
                        <div id="marketSuggestions" style="display: none; position: absolute; top: calc(100% + 0.5rem); left: 0; right: 0; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 0.75rem; max-height: 250px; overflow-y: auto; z-index: 1100; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);"></div>
                    </div>
                    
                    <!-- Filter Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <!-- Property Type Filter -->
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                <i class="fas fa-home"></i> Property Type
                            </label>
                            <select id="marketPropertyType" onchange="filterMarketInsights()" style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem; cursor: pointer;">
                                <option value="">All Types</option>
                                <option value="Residential">Residential</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Apartment">Apartment</option>
                                <option value="Villa">Villa</option>
                                <option value="Plot">Plot</option>
                                <option value="Office">Office</option>
                            </select>
                        </div>
                        
                        <!-- Trend Filter -->
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                <i class="fas fa-chart-line"></i> Price Trend
                            </label>
                            <select id="marketTrend" onchange="filterMarketInsights()" style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem; cursor: pointer;">
                                <option value="">All Trends</option>
                                <option value="up">üìà Increasing</option>
                                <option value="down">üìâ Decreasing</option>
                                <option value="stable">‚û°Ô∏è Stable</option>
                            </select>
                        </div>
                        
                        <!-- Demand Level Filter -->
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                <i class="fas fa-fire"></i> Demand Level
                            </label>
                            <select id="marketDemand" onchange="filterMarketInsights()" style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem; cursor: pointer;">
                                <option value="">All Demand</option>
                                <option value="high">üî• High (75+)</option>
                                <option value="moderate">‚ö° Moderate (50-74)</option>
                                <option value="low">‚ùÑÔ∏è Low (<50)</option>
                            </select>
                        </div>
                        
                        <!-- Sort By -->
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                <i class="fas fa-sort"></i> Sort By
                            </label>
                            <select id="marketSort" onchange="filterMarketInsights()" style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem; cursor: pointer;">
                                <option value="demand_desc">Demand: High to Low</option>
                                <option value="demand_asc">Demand: Low to High</option>
                                <option value="price_desc">Price: High to Low</option>
                                <option value="price_asc">Price: Low to High</option>
                                <option value="listings_desc">Most Listings</option>
                                <option value="change_desc">Biggest Price Change</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Search Info & Actions -->
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem;">
                        <div id="marketSearchInfo" style="display: none; padding: 0.5rem 0.75rem; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; border-radius: 0.25rem;">
                            <p style="margin: 0; color: var(--text-primary); font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                <span id="marketSearchInfoText"></span>
                            </p>
                        </div>
                        <button onclick="resetMarketFilters()" style="background: transparent; border: 2px solid var(--border-color); color: var(--text-primary); padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-redo"></i> Reset Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div style="flex: 1; overflow-y: auto; padding: 2rem;">
                <div id="marketInsightsLoading" style="display: none; text-align: center; padding: 3rem;">
                    <div style="width: 60px; height: 60px; border: 5px solid var(--border-color); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-secondary); font-size: 1.125rem; font-weight: 600;">Loading market insights...</p>
                </div>
                <div id="marketInsightsContent" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Support Tickets Modal - Chat Interface -->
    <div id="supportTicketsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); margin: 2rem auto; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); width: 95%; max-width: 900px; height: 85vh; display: flex; flex-direction: column; animation: slideDown 0.3s ease;">
            
            <!-- Chat Header -->
            <div style="padding: 1.5rem 2rem; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, #8b5cf6, #7c3aed); display: flex; justify-content: space-between; align-items: center; border-radius: 1rem 1rem 0 0;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                        <i class="fas fa-headset"></i>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; display: flex; align-items: center; gap: 0.5rem;">
                            Customer Support Chat
                        </h2>
                        <p style="margin: 0.25rem 0 0 0; color: rgba(255,255,255,0.8); font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block;"></span>
                            We're here to help 24/7
                        </p>
                    </div>
                </div>
                <button onclick="closeSupportChatModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.25rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Chat Messages Area -->
            <div id="chatMessagesArea" style="flex: 1; overflow-y: auto; padding: 2rem; background: var(--bg-secondary); background-image: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%239C92AC\" fill-opacity=\"0.03\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');">
                
                <!-- Welcome Message (Always Shown) -->
                <div data-welcome="true" style="display: flex; justify-content: flex-start; margin-bottom: 1.5rem; animation: fadeIn 0.3s ease;">
                    <div style="max-width: 70%; display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.875rem; flex-shrink: 0;">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <div style="background: white; padding: 1rem 1.25rem; border-radius: 1rem 1rem 1rem 0.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <p style="margin: 0; color: #1e293b; font-size: 0.9375rem; line-height: 1.6;">
                                    üëã Hello! I'm your support assistant. How can I help you today?
                                </p>
                            </div>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--text-secondary); padding-left: 0.5rem;">
                                Just now
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Quick Action Buttons -->
                <div id="quickActions" style="margin-bottom: 2rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: flex-start;">
                        <button class="chat-quick-action" onclick="selectIssueType('payment')" style="background: white; border: 2px solid #e2e8f0; color: #475569; padding: 0.75rem 1.25rem; border-radius: 9999px; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.color='#8b5cf6'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#475569'">
                            üí≥ Payment Issue
                        </button>
                        <button class="chat-quick-action" onclick="selectIssueType('property')" style="background: white; border: 2px solid #e2e8f0; color: #475569; padding: 0.75rem 1.25rem; border-radius: 9999px; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.color='#8b5cf6'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#475569'">
                            üè† Property Question
                        </button>
                        <button class="chat-quick-action" onclick="selectIssueType('technical')" style="background: white; border: 2px solid #e2e8f0; color: #475569; padding: 0.75rem 1.25rem; border-radius: 9999px; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.color='#8b5cf6'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#475569'">
                            üîß Technical Support
                        </button>
                        <button class="chat-quick-action" onclick="selectIssueType('general')" style="background: white; border: 2px solid #e2e8f0; color: #475569; padding: 0.75rem 1.25rem; border-radius: 9999px; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.color='#8b5cf6'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#475569'">
                            üí¨ General Question
                        </button>
                    </div>
                </div>

                <!-- Dynamic Chat Messages Container -->
                <div id="chatMessages"></div>
                
                <!-- Typing Indicator (Hidden by default) -->
                <div id="typingIndicator" style="display: none; margin-top: 1.5rem;">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.875rem;">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div style="background: white; padding: 1rem 1.25rem; border-radius: 1rem 1rem 1rem 0.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; gap: 0.25rem;">
                                <div style="width: 8px; height: 8px; background: #cbd5e1; border-radius: 50%; animation: typingDot 1.4s infinite;"></div>
                                <div style="width: 8px; height: 8px; background: #cbd5e1; border-radius: 50%; animation: typingDot 1.4s infinite 0.2s;"></div>
                                <div style="width: 8px; height: 8px; background: #cbd5e1; border-radius: 50%; animation: typingDot 1.4s infinite 0.4s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Input Area (WhatsApp-like) -->
            <div style="padding: 1.5rem 2rem; border-top: 1px solid var(--border-color); background: var(--bg-primary);">
                <div style="display: flex; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; background: var(--input-bg); border: 2px solid var(--border-color); border-radius: 1.5rem; padding: 0.75rem 1.25rem; display: flex; align-items: center; gap: 0.75rem; transition: all 0.2s;" id="chatInputContainer" onfocus="this.style.borderColor='#8b5cf6'" onblur="this.style.borderColor='var(--border-color)'">
                        <textarea id="chatMessageInput" placeholder="Type your message..." style="flex: 1; background: transparent; border: none; outline: none; color: var(--text-primary); font-size: 0.9375rem; resize: none; min-height: 24px; max-height: 120px; font-family: inherit; line-height: 1.5;" rows="1" oninput="autoResizeChatInput(this)" onkeydown="handleChatInputKeyPress(event)"></textarea>
                        <button onclick="attachFile()" style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.25rem; padding: 0.25rem; transition: all 0.2s;" onmouseover="this.style.color='#8b5cf6'" onmouseout="this.style.color='var(--text-secondary)'">
                            <i class="fas fa-paperclip"></i>
                        </button>
                    </div>
                    <button id="sendChatBtn" onclick="sendChatMessage()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; font-size: 1.125rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p style="margin: 0.75rem 0 0 0; font-size: 0.75rem; color: var(--text-secondary); text-align: center;">
                    Press Enter to send ‚Ä¢ Shift+Enter for new line
                </p>
            </div>
        </div>
    </div>

    <!-- Reviews & Feedback Modal -->
    <div id="reviewsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); margin: 2rem auto; padding: 0; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); width: 95%; max-width: 1200px; max-height: 85vh; display: flex; flex-direction: column; animation: slideDown 0.3s ease;">
            <!-- Modal Header -->
            <div style="padding: 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05));">
                <div>
                    <h2 style="margin: 0; font-size: 1.875rem; font-weight: 700; background: linear-gradient(135deg, #f59e0b, #d97706); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-star"></i> Reviews & Feedback
                    </h2>
                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">Share your property experiences and read your reviews</p>
                </div>
                <button onclick="closeReviewsModal()" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.25rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div style="flex: 1; overflow-y: auto; padding: 2rem;">
                <div id="reviewsLoading" style="display: none; text-align: center; padding: 3rem;">
                    <div style="width: 60px; height: 60px; border: 5px solid var(--border-color); border-top-color: #f59e0b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-secondary); font-size: 1.125rem; font-weight: 600;">Loading your reviews...</p>
                </div>
                <div id="reviewsContent" style="display: none;">
                    <!-- Reviews will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-brand">
            <img src="/media/newlogo.png" alt="Estate Logo">
            <div class="nav-title">Estate Management - Buyer</div>
        </div>
        
        <div class="nav-actions">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search properties, locations..." id="buyer-search-input">
            </div>
            
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                <i class="fas fa-sun" id="theme-icon"></i>
            </button>
            
            <button class="notification-btn" onclick="toggleNotificationPanel()" id="notificationBtn">
                <i class="fas fa-bell"></i>
                <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
            </button>
            
            <a href="/backend/profile/" class="user-avatar" title="View Profile">
                {% if user.profile_photo %}
                    <img src="{{ user.profile_photo.url }}" alt="Profile Photo">
                {% else %}
                    <i class="fas fa-user"></i>
                {% endif %}
            </a>
            
            <a href="/backend/logout/" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </nav>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Buyer Dashboard</h1>
            <p class="page-subtitle">Find your perfect property and manage your real estate journey</p>
        </div>

        <!-- Featured Properties Section -->
        <div class="featured-section">
            <h2 class="section-title">
                <i class="fas fa-star"></i>
                Featured Properties for You
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Based on your preferences and recent activity</p>
            <div style="display: flex; gap: 1rem; overflow-x: auto; padding: 1rem 0;">
                {% if stats.featured_properties %}
                    {% for property in stats.featured_properties %}
                    <a href="/backend/buyer/properties/" class="property-mini-card" style="text-decoration: none;">
                        <div class="property-image-container">
                            {% if property.images.first %}
                                {% load static %}
                                {% with property.images.first as first_image %}
                                    {% if first_image.image_url %}
                                        {% if first_image.image_url|slice:":4" == "http" %}
                                            <img src="{{ first_image.image_url }}" alt="{{ property.title }}" class="property-image">
                                        {% else %}
                                            <img src="/media/{{ first_image.image_url }}" alt="{{ property.title }}" class="property-image">
                                        {% endif %}
                                    {% else %}
                                        <div class="property-image-fallback">
                                            <i class="fas fa-home"></i>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                <div class="property-image-fallback">
                                    <i class="fas fa-home"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="property-mini-info">
                            <div class="property-mini-title">{{ property.title|truncatechars:20 }}</div>
                            <div class="property-mini-details">
                                <span class="property-mini-price">‚Çπ{{ property.price|floatformat:0 }}</span>
                            </div>
                            <div class="property-mini-details" style="margin-top: 0.25rem;">
                                <i class="fas fa-map-marker-alt" style="font-size: 0.7rem;"></i> {{ property.city|default:property.location|truncatechars:18 }}
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                {% else %}
                    <div class="property-mini-card">
                        <div class="property-image-container">
                            <div class="property-image-fallback">
                                <i class="fas fa-home"></i>
                            </div>
                        </div>
                        <div class="property-mini-info">
                            <div class="property-mini-title">No Properties</div>
                            <div class="property-mini-details">No properties available yet</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">Available Properties</div>
                    <i class="fas fa-home" style="color: var(--primary-teal);"></i>
                </div>
                <div style="font-size: 1.875rem; font-weight: 700; color: var(--text-primary);">{{ stats.available_properties }}</div>
                <div style="color: var(--success-green); font-size: 0.75rem; margin-top: 0.25rem;">
                    <i class="fas fa-arrow-up"></i> Ready to explore
                </div>
            </div>
            
            <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">My Bookings</div>
                    <i class="fas fa-calendar-check" style="color: var(--secondary-cyan);"></i>
                </div>
                <div style="font-size: 1.875rem; font-weight: 700; color: var(--text-primary);">{{ stats.my_bookings.total }}</div>
                <div style="color: var(--warning-amber); font-size: 0.75rem; margin-top: 0.25rem;">
                    <i class="fas fa-clock"></i> {{ stats.my_bookings.pending }} pending
                </div>
            </div>
            
            <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">Average Price</div>
                    <i class="fas fa-rupee-sign" style="color: var(--accent-emerald);"></i>
                </div>
                <div style="font-size: 1.875rem; font-weight: 700; color: var(--text-primary);">‚Çπ{% if stats.price_range.average %}{{ stats.price_range.average|floatformat:0 }}{% else %}0{% endif %}</div>
                <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">
                    <i class="fas fa-info-circle"></i> Market average
                </div>
            </div>
        </div>

        <!-- Action Cards -->
        <div class="actions-grid">
            <a href="/backend/buyer/properties/" class="action-card">
                <div class="action-header">
                    <div class="action-icon">
                        <i class="fas fa-search-location"></i>
                    </div>
                    <div class="action-content">
                        <h3>Browse Properties</h3>
                        <p>Explore thousands of properties available for sale and rent</p>
                    </div>
                </div>
                <div class="action-footer">
                    <span class="action-meta">{{ stats.available_properties }}+ properties</span>
                    <div class="action-btn">
                        Explore <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </a>

            <a href="/backend/bookings/" class="action-card">
                <div class="action-header">
                    <div class="action-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="action-content">
                        <h3>My Bookings</h3>
                        <p>Track your property bookings and viewing appointments</p>
                    </div>
                </div>
                <div class="action-footer">
                    <span class="action-meta">{{ stats.my_bookings.total }} active bookings</span>
                    <div class="action-btn">
                        View All <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </a>

            <div class="action-card" onclick="loadSavedProperties()" style="cursor: pointer;">
                <div class="action-header">
                    <div class="action-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="action-content">
                        <h3>Saved Properties</h3>
                        <p>Access your favorite properties and wishlist items</p>
                    </div>
                </div>
                <div class="action-footer">
                    <span class="action-meta" id="saved-count">Loading...</span>
                    <div class="action-btn">
                        View Favorites <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <div class="action-card" onclick="loadPaymentHistory()" style="cursor: pointer;">
                <div class="action-header">
                    <div class="action-icon">
                        <i class="fas fa-money-check-alt"></i>
                    </div>
                    <div class="action-content">
                        <h3>Payment History</h3>
                        <p>Review your transaction history and payment records</p>
                    </div>
                </div>
                <div class="action-footer">
                    <span class="action-meta" id="payment-total">Loading...</span>
                    <div class="action-btn">
                        View History <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <div class="action-card" onclick="loadMarketInsights()" style="cursor: pointer;">
                <div class="action-header">
                    <div class="action-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="action-content">
                        <h3>Market Insights</h3>
                        <p>Get price trends and market analytics for better decisions</p>
                    </div>
                </div>
                <div class="action-footer">
                    <span class="action-meta">Updated daily</span>
                    <div class="action-btn">
                        View Trends <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <div class="action-card" onclick="loadSupportTickets()" style="cursor: pointer;">
                <div class="action-header">
                    <div class="action-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    <div class="action-content">
                        <h3>Customer Support</h3>
                        <p>Get help from our expert real estate consultants</p>
                    </div>
                </div>
                <div class="action-footer">
                    <span class="action-meta" id="support-status">24/7 support</span>
                    <div class="action-btn">
                        Get Help <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <div class="action-card" onclick="loadReviews()" style="cursor: pointer;">
                <div class="action-header">
                    <div class="action-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="action-content">
                        <h3>Reviews & Feedback</h3>
                        <p>Share your experience and read property reviews</p>
                    </div>
                </div>
                <div class="action-footer">
                    <span class="action-meta" id="review-count">Help others decide</span>
                    <div class="action-btn">
                        Write Review <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </div>

            <a href="/backend/logs/" class="action-card">
                <div class="action-header">
                    <div class="action-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="action-content">
                        <h3>Activity Log</h3>
                        <p>Track your recent activities and account history</p>
                    </div>
                </div>
                <div class="action-footer">
                    <span class="action-meta">Last activity: 5 min ago</span>
                    <div class="action-btn">
                        View Activities <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            </a>
        </div>

        <!-- Quick Search & Filter Section -->
        <div id="quickSearchSection" style="margin-top: 3rem; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h2 class="section-title" style="margin: 0;">
                        <i class="fas fa-search"></i>
                        Search Results
                    </h2>
                    <p id="searchResultsCount" style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.875rem;"></p>
                </div>
                <button onclick="clearQuickSearch()" style="background: transparent; border: 2px solid var(--border-color); color: var(--text-primary); padding: 0.625rem 1.25rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-times"></i> Clear Search
                </button>
            </div>

            <!-- Advanced Filters -->
            <div id="advancedFilters" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-filter"></i> Advanced Filters
                    </h3>
                    <button id="toggleFiltersBtn" onclick="toggleFilters()" style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; transition: transform 0.3s;">
                        <i class="fas fa-chevron-up" id="filterToggleIcon"></i>
                    </button>
                </div>

                <div id="filterContent" style="display: grid; gap: 1.5rem;">
                    <!-- Price Range Filter -->
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem;">
                            <i class="fas fa-rupee-sign"></i> Price Range
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem;">
                            <input type="number" id="minPrice" placeholder="Min Price (‚Çπ)" style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                            <input type="number" id="maxPrice" placeholder="Max Price (‚Çπ)" style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="price-preset" data-min="0" data-max="5000000">Under 50L</button>
                            <button class="price-preset" data-min="5000000" data-max="10000000">50L - 1Cr</button>
                            <button class="price-preset" data-min="10000000" data-max="20000000">1Cr - 2Cr</button>
                            <button class="price-preset" data-min="20000000" data-max="50000000">2Cr - 5Cr</button>
                            <button class="price-preset" data-min="50000000" data-max="999999999">Above 5Cr</button>
                        </div>
                    </div>

                    <!-- Property Type Filter -->
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem;">
                            <i class="fas fa-home"></i> Property Type
                        </label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="type-chip" data-type="">All Types</button>
                            <button class="type-chip" data-type="Residential">Residential</button>
                            <button class="type-chip" data-type="Commercial">Commercial</button>
                            <button class="type-chip" data-type="Apartment">Apartment</button>
                            <button class="type-chip" data-type="Villa">Villa</button>
                            <button class="type-chip" data-type="Plot">Plot</button>
                            <button class="type-chip" data-type="Office">Office</button>
                        </div>
                    </div>

                    <!-- Bedrooms Filter -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                <i class="fas fa-bed"></i> Bedrooms
                            </label>
                            <select id="bedroomsFilter" style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                                <option value="">Any</option>
                                <option value="1">1 BHK</option>
                                <option value="2">2 BHK</option>
                                <option value="3">3 BHK</option>
                                <option value="4">4 BHK</option>
                                <option value="5">5+ BHK</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                <i class="fas fa-bath"></i> Bathrooms
                            </label>
                            <select id="bathroomsFilter" style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                                <option value="">Any</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4+</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                <i class="fas fa-sort"></i> Sort By
                            </label>
                            <select id="sortBy" style="width: 100%; padding: 0.75rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                                <option value="price_asc">Price: Low to High</option>
                                <option value="price_desc">Price: High to Low</option>
                                <option value="area_desc">Area: Largest First</option>
                                <option value="newest">Newest First</option>
                            </select>
                        </div>
                    </div>

                    <!-- Apply Filters Button -->
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="applyFilters()" style="flex: 1; background: linear-gradient(135deg, #14b8a6, #0d9488); color: white; border: none; padding: 0.875rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-check"></i> Apply Filters
                        </button>
                        <button onclick="resetFilters()" style="flex: 0.3; background: transparent; border: 2px solid var(--border-color); color: var(--text-primary); padding: 0.875rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="searchLoading" style="display: none; text-align: center; padding: 3rem;">
                <div style="display: inline-block; width: 50px; height: 50px; border: 4px solid var(--border-color); border-radius: 50%; border-top-color: #14b8a6; animation: spin 1s ease-in-out infinite;"></div>
                <p style="margin-top: 1rem; color: var(--text-secondary);">Searching properties...</p>
            </div>

            <!-- Search Results Grid -->
            <div id="searchResults" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;"></div>

            <!-- Empty State -->
            <div id="searchEmptyState" style="display: none; text-align: center; padding: 4rem 2rem;">
                <div style="font-size: 5rem; color: var(--text-secondary); opacity: 0.5; margin-bottom: 1.5rem;">
                    <i class="fas fa-search"></i>
                </div>
                <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">No Properties Found</h3>
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">Try adjusting your search filters or browse all available properties.</p>
                <a href="/backend/buyer/properties/" style="background: linear-gradient(135deg, #14b8a6, #0d9488); color: white; padding: 0.875rem 2rem; border-radius: 0.5rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                    <i class="fas fa-th"></i> Browse All Properties
                </a>
            </div>

            <!-- Error State -->
            <div id="searchErrorState" style="display: none; text-align: center; padding: 3rem; background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 1rem;">
                <div style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Search Error</h3>
                <p id="searchErrorMessage" style="color: var(--text-secondary); margin-bottom: 1.5rem;">Something went wrong while searching. Please try again.</p>
                <button onclick="applyFilters()" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Estate Management System. All rights reserved.</p>
    </footer>
    
    <script>
        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'light') {
                body.removeAttribute('data-theme');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                body.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }
        
        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('theme-icon');
            
            if (savedTheme === 'light') {
                document.body.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-moon';
            } else {
                // Default to dark theme
                document.body.removeAttribute('data-theme');
                themeIcon.className = 'fas fa-sun';
            }
            
            // Load saved properties count
            updateSavedPropertiesCount();
        });
        
        // Update saved properties count
        function updateSavedPropertiesCount() {
            fetch('/backend/api/buyer/saved-properties/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const countElement = document.getElementById('saved-count');
                        if (countElement) {
                            countElement.textContent = `${data.count} saved ${data.count === 1 ? 'property' : 'properties'}`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading saved count:', error);
                    const countElement = document.getElementById('saved-count');
                    if (countElement) {
                        countElement.textContent = 'View saved';
                    }
                });
        }
        
        // ===========================
        // QUICK SEARCH & FILTER FUNCTIONALITY
        // ===========================
        
        let searchTimeout;
        let currentFilters = {
            query: '',
            minPrice: '',
            maxPrice: '',
            propertyType: '',
            bedrooms: '',
            bathrooms: '',
            sortBy: 'price_asc'
        };
        
        // Search input listener with debounce
        const searchInput = document.getElementById('buyer-search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        currentFilters.query = query;
                        performQuickSearch();
                    }, 500); // 500ms debounce
                } else if (query.length === 0) {
                    clearQuickSearch();
                }
            });
            
            // Enter key support
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query) {
                        currentFilters.query = query;
                        performQuickSearch();
                    }
                }
            });
        }
        
        // Perform quick search
        function performQuickSearch() {
            const section = document.getElementById('quickSearchSection');
            const loading = document.getElementById('searchLoading');
            const results = document.getElementById('searchResults');
            const emptyState = document.getElementById('searchEmptyState');
            const errorState = document.getElementById('searchErrorState');
            
            // Show section and loading
            section.style.display = 'block';
            loading.style.display = 'block';
            results.style.display = 'none';
            emptyState.style.display = 'none';
            errorState.style.display = 'none';
            
            // Scroll to results
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Build query string
            let queryParams = [];
            if (currentFilters.query) queryParams.push(`q=${encodeURIComponent(currentFilters.query)}`);
            if (currentFilters.minPrice) queryParams.push(`min_price=${currentFilters.minPrice}`);
            if (currentFilters.maxPrice) queryParams.push(`max_price=${currentFilters.maxPrice}`);
            if (currentFilters.propertyType) queryParams.push(`type=${encodeURIComponent(currentFilters.propertyType)}`);
            if (currentFilters.bedrooms) queryParams.push(`bedrooms=${currentFilters.bedrooms}`);
            if (currentFilters.bathrooms) queryParams.push(`bathrooms=${currentFilters.bathrooms}`);
            
            const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '';
            
            // Fetch from backend API (we'll use the properties view API pattern)
            fetch(`/backend/api/buyer/quick-search/${queryString}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (data.success && data.properties && data.properties.length > 0) {
                        displayQuickSearchResults(data.properties);
                        results.style.display = 'grid';
                    } else {
                        emptyState.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    loading.style.display = 'none';
                    errorState.style.display = 'block';
                    document.getElementById('searchErrorMessage').textContent = 
                        `Error: ${error.message}. Please try again or browse all properties.`;
                });
        }
        
        // Display quick search results
        function displayQuickSearchResults(properties) {
            const results = document.getElementById('searchResults');
            const countElem = document.getElementById('searchResultsCount');
            
            countElem.textContent = `Found ${properties.length} ${properties.length === 1 ? 'property' : 'properties'}`;
            
            // Sort results
            properties = sortProperties(properties, currentFilters.sortBy);
            
            let html = '';
            properties.forEach(property => {
                const formattedPrice = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    maximumFractionDigits: 0
                }).format(property.price);
                
                const imageUrl = property.image_url || '/media/default-property.jpg';
                
                html += `
                    <div class="quick-search-property-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1rem; overflow: hidden; transition: all 0.3s; cursor: pointer;" onclick="viewPropertyDetails(${property.property_id})">
                        <!-- Property Image -->
                        <div style="position: relative; height: 200px; overflow: hidden; background: linear-gradient(135deg, #14b8a6, #0d9488);">
                            ${property.image_url ? `
                                <img src="${imageUrl}" alt="${property.title}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; font-size: 3rem; color: white;">
                                    <i class="fas fa-home"></i>
                                </div>
                            ` : `
                                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white;">
                                    <i class="fas fa-home"></i>
                                </div>
                            `}
                            
                            <!-- Status Badge -->
                            <div style="position: absolute; top: 0.75rem; left: 0.75rem;">
                                <span style="background: ${property.status === 'Available' ? 'rgba(16, 185, 129, 0.95)' : 'rgba(239, 68, 68, 0.95)'}; color: white; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; backdrop-filter: blur(10px);">
                                    ${property.status}
                                </span>
                            </div>
                            
                            <!-- Property Type Badge -->
                            <div style="position: absolute; top: 0.75rem; right: 0.75rem;">
                                <span style="background: rgba(20, 184, 166, 0.95); color: white; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; backdrop-filter: blur(10px);">
                                    ${property.property_type || 'Property'}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Property Details -->
                        <div style="padding: 1.25rem;">
                            <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${property.title}
                            </h3>
                            
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${property.city || property.location}, ${property.state || ''}</span>
                            </div>
                            
                            <!-- Property Stats -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; padding: 0.75rem; background: var(--input-bg); border-radius: 0.5rem; margin-bottom: 1rem;">
                                ${property.bedrooms ? `
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Beds</div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${property.bedrooms}</div>
                                    </div>
                                ` : ''}
                                ${property.bathrooms ? `
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Baths</div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${property.bathrooms}</div>
                                    </div>
                                ` : ''}
                                ${property.area_sqft ? `
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Area</div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${property.area_sqft} sq ft</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Price -->
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #14b8a6;">
                                    ${formattedPrice}
                                </div>
                                <button onclick="event.stopPropagation(); viewPropertyDetails(${property.property_id})" style="background: linear-gradient(135deg, #14b8a6, #0d9488); color: white; border: none; padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;">
                                    View <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            results.innerHTML = html;
        }
        
        // Sort properties
        function sortProperties(properties, sortBy) {
            const sorted = [...properties];
            
            switch(sortBy) {
                case 'price_asc':
                    sorted.sort((a, b) => a.price - b.price);
                    break;
                case 'price_desc':
                    sorted.sort((a, b) => b.price - a.price);
                    break;
                case 'area_desc':
                    sorted.sort((a, b) => (b.area_sqft || 0) - (a.area_sqft || 0));
                    break;
                case 'newest':
                    sorted.sort((a, b) => (b.property_id || 0) - (a.property_id || 0));
                    break;
            }
            
            return sorted;
        }
        
        // View property details
        function viewPropertyDetails(propertyId) {
            window.location.href = `/backend/buyer/properties/?property_id=${propertyId}`;
        }
        
        // Clear quick search
        function clearQuickSearch() {
            document.getElementById('quickSearchSection').style.display = 'none';
            document.getElementById('buyer-search-input').value = '';
            currentFilters = {
                query: '',
                minPrice: '',
                maxPrice: '',
                propertyType: '',
                bedrooms: '',
                bathrooms: '',
                sortBy: 'price_asc'
            };
            resetFilters();
        }
        
        // ===========================
        // FILTER FUNCTIONS
        // ===========================
        
        // Toggle filters panel
        function toggleFilters() {
            const content = document.getElementById('filterContent');
            const icon = document.getElementById('filterToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'grid';
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }
        
        // Apply filters
        function applyFilters() {
            currentFilters.minPrice = document.getElementById('minPrice').value;
            currentFilters.maxPrice = document.getElementById('maxPrice').value;
            currentFilters.bedrooms = document.getElementById('bedroomsFilter').value;
            currentFilters.bathrooms = document.getElementById('bathroomsFilter').value;
            currentFilters.sortBy = document.getElementById('sortBy').value;
            
            if (currentFilters.query || currentFilters.minPrice || currentFilters.maxPrice || 
                currentFilters.propertyType || currentFilters.bedrooms || currentFilters.bathrooms) {
                performQuickSearch();
            }
        }
        
        // Reset filters
        function resetFilters() {
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('bedroomsFilter').value = '';
            document.getElementById('bathroomsFilter').value = '';
            document.getElementById('sortBy').value = 'price_asc';
            
            currentFilters.minPrice = '';
            currentFilters.maxPrice = '';
            currentFilters.propertyType = '';
            currentFilters.bedrooms = '';
            currentFilters.bathrooms = '';
            currentFilters.sortBy = 'price_asc';
            
            // Remove active state from all chips
            document.querySelectorAll('.type-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector('.type-chip[data-type=""]').classList.add('active');
        }
        
        // Price preset buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.price-preset').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('minPrice').value = this.getAttribute('data-min');
                    document.getElementById('maxPrice').value = this.getAttribute('data-max');
                    
                    // Remove active from all
                    document.querySelectorAll('.price-preset').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Property type chips
            document.querySelectorAll('.type-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('.type-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    currentFilters.propertyType = this.getAttribute('data-type');
                });
            });
            
            // Set "All Types" as active by default
            document.querySelector('.type-chip[data-type=""]').classList.add('active');
        });

        // Saved Properties Functions
        function loadSavedProperties() {
            const modal = document.getElementById('savedPropertiesModal');
            const loading = document.getElementById('savedPropertiesLoading');
            const content = document.getElementById('savedPropertiesContent');
            
            // Show modal
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.style.display = 'none';
            
            // Fetch saved properties
            fetch('/backend/api/buyer/saved-properties/')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (data.success && data.properties.length > 0) {
                        displaySavedProperties(data.properties);
                        content.style.display = 'block';
                    } else {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 3rem;">
                                <div style="font-size: 4rem; color: #94a3b8; margin-bottom: 1rem;">
                                    <i class="fas fa-heart-broken"></i>
                                </div>
                                <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">No Saved Properties</h3>
                                <p style="color: #64748b; margin-bottom: 1.5rem;">You haven't saved any properties yet. Start exploring!</p>
                                <a href="/backend/buyer/properties/" style="background: linear-gradient(135deg, #14b8a6, #0d9488); color: white; padding: 0.75rem 2rem; border-radius: 0.5rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                                    <i class="fas fa-search"></i> Browse Properties
                                </a>
                            </div>
                        `;
                        content.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading saved properties:', error);
                    loading.style.display = 'none';
                    content.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Error loading saved properties. Please try again.</p>
                        </div>
                    `;
                    content.style.display = 'block';
                });
        }

        function displaySavedProperties(properties) {
            const content = document.getElementById('savedPropertiesContent');
            
            let html = '<div style="display: grid; gap: 1.5rem;">';
            
            properties.forEach(property => {
                const imageUrl = property.image_url || '/media/default-property.jpg';
                const formattedPrice = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    maximumFractionDigits: 0
                }).format(property.price);
                
                html += `
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1rem; overflow: hidden; display: grid; grid-template-columns: 200px 1fr auto; transition: all 0.3s ease;">
                        <!-- Property Image -->
                        <div style="height: 100%; min-height: 180px; background: linear-gradient(135deg, #14b8a6, #0d9488); position: relative; overflow: hidden;">
                            ${property.image_url ? `
                                <img src="${imageUrl}" alt="${property.title}" style="width: 100%; height: 100%; object-fit: cover;">
                            ` : `
                                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white;">
                                    <i class="fas fa-home"></i>
                                </div>
                            `}
                            
                            <!-- Status Badge -->
                            <div style="position: absolute; top: 0.75rem; right: 0.75rem;">
                                <span style="background: ${property.status === 'Available' ? 'rgba(16, 185, 129, 0.95)' : 'rgba(239, 68, 68, 0.95)'}; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                                    ${property.status}
                                </span>
                            </div>
                        </div>

                        <!-- Property Details -->
                        <div style="padding: 1.5rem;">
                            <div style="margin-bottom: 1rem;">
                                <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                    ${property.title}
                                </h3>
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.25rem;">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${property.city}, ${property.state}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                                    <i class="fas fa-heart"></i>
                                    <span>Saved on ${new Date(property.saved_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; padding: 1rem; background: var(--input-bg); border-radius: 0.5rem; margin-bottom: 1rem;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Type</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${property.property_type}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Price</div>
                                    <div style="font-weight: 700; color: #14b8a6; font-size: 1.125rem;">${formattedPrice}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Area</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${property.area_sqft} sq ft</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Beds/Baths</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${property.bedrooms}/${property.bathrooms}</div>
                                </div>
                            </div>

                            ${property.notes ? `
                                <div style="background: rgba(20, 184, 166, 0.1); padding: 0.75rem; border-radius: 0.5rem; border-left: 3px solid #14b8a6;">
                                    <div style="font-size: 0.75rem; color: #14b8a6; font-weight: 600; margin-bottom: 0.25rem;">
                                        <i class="fas fa-sticky-note"></i> My Notes
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--text-primary);">${property.notes}</div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Actions Column -->
                        <div style="padding: 1.5rem; border-left: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 0.75rem; min-width: 180px;">
                            <button class="btn-view-details" data-property-id="${property.property_id}" style="background: linear-gradient(135deg, #14b8a6, #0d9488); color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            
                            <button class="btn-edit-notes" data-saved-id="${property.saved_id}" data-notes="${(property.notes || '').replace(/"/g, '&quot;')}" data-title="${property.title.replace(/"/g, '&quot;')}" style="background: rgba(20, 184, 166, 0.1); color: #14b8a6; border: none; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-edit"></i> Edit Notes
                            </button>
                            
                            <button class="btn-remove-property" data-saved-id="${property.saved_id}" data-title="${property.title.replace(/"/g, '&quot;')}" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
            
            // Add event listeners to dynamically created buttons
            setTimeout(() => {
                // View Details buttons
                document.querySelectorAll('.btn-view-details').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const propertyId = this.getAttribute('data-property-id');
                        viewPropertyDetailsFromSaved(propertyId);
                    });
                });
                
                // Edit Notes buttons
                document.querySelectorAll('.btn-edit-notes').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const savedId = this.getAttribute('data-saved-id');
                        const notes = this.getAttribute('data-notes');
                        const title = this.getAttribute('data-title');
                        editNotes(savedId, notes, title);
                    });
                });
                
                // Remove buttons
                document.querySelectorAll('.btn-remove-property').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const savedId = this.getAttribute('data-saved-id');
                        const title = this.getAttribute('data-title');
                        removeSavedProperty(savedId, title);
                    });
                });
            }, 100);
        }

        function closeSavedPropertiesModal() {
            document.getElementById('savedPropertiesModal').style.display = 'none';
        }

        function viewPropertyDetailsFromSaved(propertyId) {
            // Redirect to browse properties page and automatically open property details
            window.location.href = `/backend/buyer/properties/?property_id=${propertyId}`;
        }

        function editNotes(savedId, currentNotes, propertyTitle) {
            const newNotes = prompt(`Edit notes for "${propertyTitle}":`, currentNotes || '');
            
            if (newNotes !== null) {
                // Update notes via API (you'll need to implement this endpoint)
                fetch(`/backend/api/buyer/saved-properties/${savedId}/notes/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ notes: newNotes })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Notes updated successfully!');
                        loadSavedProperties(); // Reload the list
                    } else {
                        alert('Error updating notes: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating notes.');
                });
            }
        }

        function removeSavedProperty(savedId, propertyTitle) {
            if (confirm(`Remove "${propertyTitle}" from saved properties?`)) {
                fetch(`/backend/api/buyer/saved-properties/${savedId}/remove/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Property removed from saved list!');
                        loadSavedProperties(); // Reload the list
                    } else {
                        alert('Error removing property: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while removing the property.');
                });
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Payment History Functions
        let allTransactions = []; // Store all transactions for filtering
        let totalTransactionAmount = 0; // Store total amount
        
        function loadPaymentHistory() {
            const modal = document.getElementById('paymentHistoryModal');
            const loading = document.getElementById('paymentHistoryLoading');
            const content = document.getElementById('paymentHistoryContent');
            
            // Clear search input
            document.getElementById('txnSearchInput').value = '';
            document.getElementById('clearTxnSearch').style.display = 'none';
            document.getElementById('txnSearchInfo').style.display = 'none';
            
            // Show modal
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.style.display = 'none';
            
            // Fetch transaction history
            fetch('/backend/api/buyer/transactions/')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (data.success && data.transactions.length > 0) {
                        allTransactions = data.transactions; // Store globally
                        totalTransactionAmount = data.total_amount;
                        displayTransactionHistory(allTransactions, totalTransactionAmount);
                        content.style.display = 'block';
                    } else {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 3rem;">
                                <div style="font-size: 4rem; color: #94a3b8; margin-bottom: 1rem;">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">No Transactions Yet</h3>
                                <p style="color: #64748b; margin-bottom: 1.5rem;">You haven't made any transactions yet.</p>
                            </div>
                        `;
                        content.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading transaction history:', error);
                    loading.style.display = 'none';
                    content.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Error loading transaction history. Please try again.</p>
                        </div>
                    `;
                    content.style.display = 'block';
                });
        }

        function displayTransactionHistory(transactions, totalAmount) {
            const content = document.getElementById('paymentHistoryContent');
            
            // Check if no transactions
            if (transactions.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 4rem 2rem;">
                        <div style="font-size: 5rem; color: var(--text-secondary); opacity: 0.3; margin-bottom: 1.5rem;">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">No Transactions Found</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">No transactions match your search criteria. Try a different transaction ID.</p>
                        <button onclick="clearTransactionSearch()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 0.875rem 2rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-redo"></i> View All Transactions
                        </button>
                    </div>
                `;
                return;
            }
            
            const formattedTotal = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(totalAmount);
            
            let html = `
                <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 1.5rem; border-radius: 1rem; margin-bottom: 1.5rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">${transactions.length === allTransactions.length ? 'Total Successful Payments' : `Filtered Transactions (${transactions.length})`}</div>
                            <div style="font-size: 2rem; font-weight: 700;">${formattedTotal}</div>
                        </div>
                        <div style="font-size: 3rem; opacity: 0.3;">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                </div>
                
                <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1rem; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--input-bg); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 0.875rem;">TXN ID</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 0.875rem;">Property</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 0.875rem;">Location</th>
                                <th style="padding: 1rem; text-align: right; font-weight: 600; color: var(--text-secondary); font-size: 0.875rem;">Amount</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text-secondary); font-size: 0.875rem;">Status</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 0.875rem;">Date</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            transactions.forEach((txn, index) => {
                const formattedAmount = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    maximumFractionDigits: 0
                }).format(txn.amount);
                
                const statusColor = {
                    'success': '#10b981',
                    'pending': '#f59e0b',
                    'failed': '#ef4444'
                }[txn.payment_status] || '#6b7280';
                
                const statusIcon = {
                    'success': 'check-circle',
                    'pending': 'clock',
                    'failed': 'times-circle'
                }[txn.payment_status] || 'question-circle';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='var(--input-bg)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 1rem; color: var(--text-secondary); font-family: monospace;">#${txn.txn_id}</td>
                        <td style="padding: 1rem; color: var(--text-primary); font-weight: 500;">${txn.property_title}</td>
                        <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                            <i class="fas fa-map-marker-alt" style="margin-right: 0.25rem;"></i>${txn.property_location}
                        </td>
                        <td style="padding: 1rem; text-align: right; color: var(--text-primary); font-weight: 600; font-size: 1.125rem;">${formattedAmount}</td>
                        <td style="padding: 1rem; text-align: center;">
                            <span style="background: ${statusColor}20; color: ${statusColor}; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: inline-flex; align-items: center; gap: 0.375rem;">
                                <i class="fas fa-${statusIcon}"></i> ${txn.payment_status}
                            </span>
                        </td>
                        <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                            <i class="far fa-calendar-alt" style="margin-right: 0.25rem;"></i>${new Date(txn.payment_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            content.innerHTML = html;
        }

        function closePaymentHistoryModal() {
            const modal = document.getElementById('paymentHistoryModal');
            modal.style.display = 'none';
            // Clear search
            document.getElementById('txnSearchInput').value = '';
            allTransactions = [];
            totalTransactionAmount = 0;
        }
        
        // Filter Transactions by Search
        function filterTransactions() {
            const searchInput = document.getElementById('txnSearchInput');
            const clearBtn = document.getElementById('clearTxnSearch');
            const searchInfo = document.getElementById('txnSearchInfo');
            const searchInfoText = document.getElementById('txnSearchInfoText');
            const query = searchInput.value.trim();
            
            // Show/hide clear button
            if (query) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
                searchInfo.style.display = 'none';
            }
            
            // If no query, show all transactions
            if (!query) {
                displayTransactionHistory(allTransactions, totalTransactionAmount);
                return;
            }
            
            // Filter transactions
            const filtered = allTransactions.filter(txn => {
                const txnId = txn.txn_id.toString();
                const searchQuery = query.replace('#', '').toLowerCase();
                
                // Match by transaction ID
                if (txnId.includes(searchQuery)) {
                    return true;
                }
                
                // Also match by property name or location (optional)
                if (txn.property_title && txn.property_title.toLowerCase().includes(searchQuery)) {
                    return true;
                }
                
                if (txn.property_location && txn.property_location.toLowerCase().includes(searchQuery)) {
                    return true;
                }
                
                return false;
            });
            
            // Show search info
            searchInfo.style.display = 'block';
            if (filtered.length > 0) {
                searchInfoText.textContent = `Found ${filtered.length} transaction${filtered.length === 1 ? '' : 's'} matching "${query}"`;
            } else {
                searchInfoText.innerHTML = `<span style="color: #ef4444;">No transactions found matching "${query}"</span>`;
            }
            
            // Calculate filtered total
            const filteredTotal = filtered.reduce((sum, txn) => sum + parseFloat(txn.amount), 0);
            
            // Display filtered results
            displayTransactionHistory(filtered, filteredTotal);
        }
        
        // Clear Transaction Search
        function clearTransactionSearch() {
            document.getElementById('txnSearchInput').value = '';
            document.getElementById('clearTxnSearch').style.display = 'none';
            document.getElementById('txnSearchInfo').style.display = 'none';
            displayTransactionHistory(allTransactions, totalTransactionAmount);
        }

        // Market Insights Functions
        function loadMarketInsights() {
            const modal = document.getElementById('marketInsightsModal');
            const loading = document.getElementById('marketInsightsLoading');
            const content = document.getElementById('marketInsightsContent');
            
            // Show modal
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.style.display = 'none';
            
            // Fetch market insights
            fetch('/backend/api/buyer/market-insights/')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (data.success && data.insights.length > 0) {
                        // Store data globally for filtering
                        allMarketInsights = data.insights;
                        
                        // Build suggestions data
                        marketSuggestionsData.locations.clear();
                        marketSuggestionsData.propertyTypes.clear();
                        data.insights.forEach(insight => {
                            marketSuggestionsData.locations.add(insight.location);
                            marketSuggestionsData.propertyTypes.add(insight.property_type);
                        });
                        
                        displayMarketInsights(data.insights);
                        content.style.display = 'block';
                    } else {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 3rem;">
                                <div style="font-size: 4rem; color: #94a3b8; margin-bottom: 1rem;">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">No Market Data Available</h3>
                                <p style="color: #64748b; margin-bottom: 1.5rem;">Market insights data is being updated. Please check back later.</p>
                            </div>
                        `;
                        content.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading market insights:', error);
                    loading.style.display = 'none';
                    content.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Error loading market insights. Please try again.</p>
                        </div>
                    `;
                    content.style.display = 'block';
                });
        }

        function displayMarketInsights(insights) {
            const content = document.getElementById('marketInsightsContent');
            
            // Group insights by location
            const byLocation = {};
            insights.forEach(insight => {
                if (!byLocation[insight.location]) {
                    byLocation[insight.location] = [];
                }
                byLocation[insight.location].push(insight);
            });
            
            let html = `
                <div style="display: grid; gap: 2rem;">
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
            `;
            
            // Calculate overall statistics
            const avgPriceChange = insights.reduce((sum, i) => sum + i.price_change_percent, 0) / insights.length;
            const totalListings = insights.reduce((sum, i) => sum + i.total_listings, 0);
            const avgDemand = insights.reduce((sum, i) => sum + i.demand_score, 0) / insights.length;
            const avgDaysOnMarket = insights.reduce((sum, i) => sum + i.days_on_market, 0) / insights.length;
            
            // Summary Card 1: Average Price Change
            const priceChangeColor = avgPriceChange >= 0 ? '#10b981' : '#ef4444';
            const priceChangeIcon = avgPriceChange >= 0 ? 'arrow-up' : 'arrow-down';
            html += `
                <div style="background: linear-gradient(135deg, ${avgPriceChange >= 0 ? '#10b981' : '#ef4444'}, ${avgPriceChange >= 0 ? '#059669' : '#dc2626'}); padding: 1.5rem; border-radius: 1rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div style="font-size: 0.875rem; opacity: 0.9;">Avg. Price Change</div>
                        <i class="fas fa-${priceChangeIcon}" style="font-size: 1.5rem; opacity: 0.5;"></i>
                    </div>
                    <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.25rem;">${avgPriceChange >= 0 ? '+' : ''}${avgPriceChange.toFixed(1)}%</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">Last 30 days</div>
                </div>
            `;
            
            // Summary Card 2: Total Listings
            html += `
                <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 1.5rem; border-radius: 1rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div style="font-size: 0.875rem; opacity: 0.9;">Total Listings</div>
                        <i class="fas fa-building" style="font-size: 1.5rem; opacity: 0.5;"></i>
                    </div>
                    <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.25rem;">${totalListings}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">Active properties</div>
                </div>
            `;
            
            // Summary Card 3: Average Demand
            const demandColor = avgDemand >= 75 ? '#10b981' : avgDemand >= 50 ? '#f59e0b' : '#ef4444';
            html += `
                <div style="background: linear-gradient(135deg, ${demandColor}, ${demandColor}dd); padding: 1.5rem; border-radius: 1rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div style="font-size: 0.875rem; opacity: 0.9;">Market Demand</div>
                        <i class="fas fa-fire" style="font-size: 1.5rem; opacity: 0.5;"></i>
                    </div>
                    <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.25rem;">${avgDemand.toFixed(0)}/100</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">${avgDemand >= 75 ? 'High' : avgDemand >= 50 ? 'Moderate' : 'Low'} demand</div>
                </div>
            `;
            
            // Summary Card 4: Avg Days on Market
            html += `
                <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 1.5rem; border-radius: 1rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div style="font-size: 0.875rem; opacity: 0.9;">Avg. Days on Market</div>
                        <i class="fas fa-clock" style="font-size: 1.5rem; opacity: 0.5;"></i>
                    </div>
                    <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.25rem;">${Math.round(avgDaysOnMarket)}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">Days to sell</div>
                </div>
            `;
            
            html += `
                    </div>
                    
                    <!-- Location-wise Insights -->
                    <div style="display: grid; gap: 1.5rem;">
            `;
            
            // Display insights grouped by location
            Object.keys(byLocation).forEach((location, index) => {
                const locationInsights = byLocation[location];
                const locationAvgPrice = locationInsights.reduce((sum, i) => sum + i.average_price, 0) / locationInsights.length;
                const locationPriceChange = locationInsights.reduce((sum, i) => sum + i.price_change_percent, 0) / locationInsights.length;
                
                const formattedAvgPrice = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    maximumFractionDigits: 0
                }).format(locationAvgPrice);
                
                html += `
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1rem; overflow: hidden;">
                        <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05)); border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-map-marker-alt" style="color: #3b82f6;"></i> ${location}
                                    </h3>
                                    <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">Property market overview</p>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Avg. Price</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">${formattedAvgPrice}</div>
                                    <div style="font-size: 0.875rem; color: ${locationPriceChange >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                        <i class="fas fa-${locationPriceChange >= 0 ? 'arrow-up' : 'arrow-down'}"></i> ${locationPriceChange >= 0 ? '+' : ''}${locationPriceChange.toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                `;
                
                // Display each property type in this location
                locationInsights.forEach(insight => {
                    const formattedPrice = new Intl.NumberFormat('en-IN', {
                        style: 'currency',
                        currency: 'INR',
                        maximumFractionDigits: 0
                    }).format(insight.average_price);
                    
                    const sellRate = insight.total_listings > 0 ? ((insight.sold_count / insight.total_listings) * 100).toFixed(1) : 0;
                    const demandBarColor = insight.demand_score >= 75 ? '#10b981' : insight.demand_score >= 50 ? '#f59e0b' : '#ef4444';
                    
                    html += `
                        <div style="background: var(--input-bg); padding: 1.25rem; border-radius: 0.75rem; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-primary);">${insight.property_type}</h4>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Average Price</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">${formattedPrice}</div>
                                <div style="font-size: 0.875rem; color: ${insight.price_change_percent >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600; margin-top: 0.25rem;">
                                    <i class="fas fa-${insight.price_change_percent >= 0 ? 'trending-up' : 'trending-down'}"></i> ${insight.price_change_percent >= 0 ? '+' : ''}${insight.price_change_percent}%
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem; font-size: 0.875rem;">
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 0.75rem;">Listings</div>
                                    <div style="color: var(--text-primary); font-weight: 600;">${insight.total_listings}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 0.75rem;">Sold</div>
                                    <div style="color: var(--text-primary); font-weight: 600;">${insight.sold_count} (${sellRate}%)</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 0.75rem;">Days on Market</div>
                                    <div style="color: var(--text-primary); font-weight: 600;">${insight.days_on_market} days</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 0.75rem;">Period</div>
                                    <div style="color: var(--text-primary); font-weight: 600; font-size: 0.75rem;">${new Date(insight.period_start).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</div>
                                </div>
                            </div>
                            
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Demand Score</span>
                                    <span style="font-size: 0.875rem; font-weight: 700; color: ${demandBarColor};">${insight.demand_score.toFixed(0)}/100</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: var(--border-color); border-radius: 9999px; overflow: hidden;">
                                    <div style="width: ${insight.demand_score}%; height: 100%; background: ${demandBarColor}; border-radius: 9999px; transition: width 0.5s ease;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        function closeMarketInsightsModal() {
            const modal = document.getElementById('marketInsightsModal');
            modal.style.display = 'none';
        }

        // Market Insights Search & Filter Functions
        let allMarketInsights = []; // Global storage for filtering
        let marketSuggestionsData = { locations: new Set(), propertyTypes: new Set() };

        // Handle search input with debouncing
        let marketSearchTimeout;
        function handleMarketSearch(event) {
            clearTimeout(marketSearchTimeout);
            const query = event.target.value.trim();
            
            // Show/hide clear button
            document.getElementById('clearMarketBtn').style.display = query ? 'flex' : 'none';
            
            // Show suggestions if query length >= 2
            if (query.length >= 2) {
                showMarketSuggestions(query);
            } else {
                hideMarketSuggestions();
            }
            
            // Debounce the actual filtering
            marketSearchTimeout = setTimeout(() => {
                filterMarketInsights();
            }, 300);
        }

        // Show autocomplete suggestions
        function showMarketSuggestions(query) {
            const suggestionsDiv = document.getElementById('marketSuggestions');
            const lowerQuery = query.toLowerCase();
            
            // Get matching locations and property types
            const matchingLocations = Array.from(marketSuggestionsData.locations)
                .filter(loc => loc.toLowerCase().includes(lowerQuery))
                .slice(0, 3);
            
            const matchingTypes = Array.from(marketSuggestionsData.propertyTypes)
                .filter(type => type.toLowerCase().includes(lowerQuery))
                .slice(0, 3);
            
            if (matchingLocations.length === 0 && matchingTypes.length === 0) {
                hideMarketSuggestions();
                return;
            }
            
            let html = '<div style="padding: 0.5rem;">';
            
            if (matchingLocations.length > 0) {
                html += '<div style="padding: 0.5rem 0.75rem; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Locations</div>';
                matchingLocations.forEach(loc => {
                    html += `
                        <div onclick="selectMarketSuggestion('${escapeHtml(loc)}')" style="padding: 0.75rem; cursor: pointer; border-radius: 0.5rem; transition: background 0.2s; display: flex; align-items: center; gap: 0.75rem;" onmouseover="this.style.background='var(--input-bg)'" onmouseout="this.style.background='transparent'">
                            <i class="fas fa-map-marker-alt" style="color: #3b82f6; font-size: 0.875rem;"></i>
                            <span style="color: var(--text-primary); font-size: 0.875rem;">${escapeHtml(loc)}</span>
                        </div>
                    `;
                });
            }
            
            if (matchingTypes.length > 0) {
                html += '<div style="padding: 0.5rem 0.75rem; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.5rem;">Property Types</div>';
                matchingTypes.forEach(type => {
                    html += `
                        <div onclick="selectMarketSuggestion('${escapeHtml(type)}')" style="padding: 0.75rem; cursor: pointer; border-radius: 0.5rem; transition: background 0.2s; display: flex; align-items: center; gap: 0.75rem;" onmouseover="this.style.background='var(--input-bg)'" onmouseout="this.style.background='transparent'">
                            <i class="fas fa-home" style="color: #3b82f6; font-size: 0.875rem;"></i>
                            <span style="color: var(--text-primary); font-size: 0.875rem;">${escapeHtml(type)}</span>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        }

        function hideMarketSuggestions() {
            document.getElementById('marketSuggestions').style.display = 'none';
        }

        function selectMarketSuggestion(value) {
            document.getElementById('marketSearchInput').value = value;
            hideMarketSuggestions();
            document.getElementById('clearMarketBtn').style.display = 'flex';
            filterMarketInsights();
        }

        // Main filter function
        function filterMarketInsights() {
            const searchQuery = document.getElementById('marketSearchInput').value.toLowerCase().trim();
            const propertyType = document.getElementById('marketPropertyType').value;
            const trend = document.getElementById('marketTrend').value;
            const demand = document.getElementById('marketDemand').value;
            const sortBy = document.getElementById('marketSort').value;
            
            // Filter insights
            let filtered = allMarketInsights.filter(insight => {
                // Search query filter (location OR property type)
                if (searchQuery) {
                    const matchLocation = insight.location.toLowerCase().includes(searchQuery);
                    const matchType = insight.property_type.toLowerCase().includes(searchQuery);
                    if (!matchLocation && !matchType) return false;
                }
                
                // Property type filter
                if (propertyType && insight.property_type !== propertyType) return false;
                
                // Trend filter
                if (trend) {
                    if (trend === 'up' && insight.price_change_percent <= 0) return false;
                    if (trend === 'down' && insight.price_change_percent >= 0) return false;
                    if (trend === 'stable' && Math.abs(insight.price_change_percent) > 2) return false;
                }
                
                // Demand filter
                if (demand) {
                    if (demand === 'high' && insight.demand_score < 75) return false;
                    if (demand === 'moderate' && (insight.demand_score < 50 || insight.demand_score >= 75)) return false;
                    if (demand === 'low' && insight.demand_score >= 50) return false;
                }
                
                return true;
            });
            
            // Sort insights
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'demand_desc':
                        return b.demand_score - a.demand_score;
                    case 'demand_asc':
                        return a.demand_score - b.demand_score;
                    case 'price_desc':
                        return b.average_price - a.average_price;
                    case 'price_asc':
                        return a.average_price - b.average_price;
                    case 'listings_desc':
                        return b.total_listings - a.total_listings;
                    case 'change_desc':
                        return Math.abs(b.price_change_percent) - Math.abs(a.price_change_percent);
                    default:
                        return b.demand_score - a.demand_score;
                }
            });
            
            // Update search info
            const searchInfo = document.getElementById('marketSearchInfo');
            const searchInfoText = document.getElementById('marketSearchInfoText');
            
            if (filtered.length < allMarketInsights.length) {
                searchInfo.style.display = 'block';
                searchInfoText.textContent = `Showing ${filtered.length} of ${allMarketInsights.length} market insights`;
            } else {
                searchInfo.style.display = 'none';
            }
            
            // Display filtered results
            if (filtered.length > 0) {
                displayMarketInsights(filtered);
            } else {
                // Show empty state
                const content = document.getElementById('marketInsightsContent');
                content.innerHTML = `
                    <div style="text-align: center; padding: 4rem 2rem;">
                        <div style="font-size: 5rem; color: var(--text-secondary); opacity: 0.3; margin-bottom: 1.5rem;">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.75rem;">
                            No Results Found
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 1rem; margin-bottom: 2rem; max-width: 500px; margin-left: auto; margin-right: auto;">
                            No market insights match your search criteria. Try adjusting your filters or search terms.
                        </p>
                        <button onclick="resetMarketFilters()" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 0.875rem 2rem; border-radius: 0.75rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);">
                            <i class="fas fa-redo" style="margin-right: 0.5rem;"></i> Reset Filters
                        </button>
                    </div>
                `;
            }
        }

        // Clear search
        function clearMarketSearch() {
            document.getElementById('marketSearchInput').value = '';
            document.getElementById('clearMarketBtn').style.display = 'none';
            hideMarketSuggestions();
            filterMarketInsights();
        }

        // Reset all filters
        function resetMarketFilters() {
            document.getElementById('marketSearchInput').value = '';
            document.getElementById('marketPropertyType').value = '';
            document.getElementById('marketTrend').value = '';
            document.getElementById('marketDemand').value = '';
            document.getElementById('marketSort').value = 'demand_desc';
            document.getElementById('clearMarketBtn').style.display = 'none';
            document.getElementById('marketSearchInfo').style.display = 'none';
            hideMarketSuggestions();
            
            // Show all insights
            displayMarketInsights(allMarketInsights);
        }

        // Support Tickets Functions
        function loadSupportTickets() {
            const modal = document.getElementById('supportTicketsModal');
            const loading = document.getElementById('supportTicketsLoading');
            const content = document.getElementById('supportTicketsContent');
            
            // Show modal
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.style.display = 'none';
            
            // Fetch support tickets
            fetch('/backend/api/buyer/support-tickets/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loading.style.display = 'none';
                    console.log('Support tickets data:', data); // Debug log
                    
                    if (data.success) {
                        displaySupportTickets(data.tickets, data.stats);
                        content.style.display = 'block';
                    } else {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #ef4444;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>Error: ${data.error || 'Unknown error occurred'}</p>
                                <button onclick="loadSupportTickets()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #8b5cf6; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">Try Again</button>
                            </div>
                        `;
                        content.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading support tickets:', error);
                    loading.style.display = 'none';
                    content.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Error loading support tickets: ${error.message}</p>
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">Please check the browser console for more details.</p>
                            <button onclick="loadSupportTickets()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #8b5cf6; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">Try Again</button>
                        </div>
                    `;
                    content.style.display = 'block';
                });
        }

        function displaySupportTickets(tickets, stats) {
            const content = document.getElementById('supportTicketsContent');
            
            let html = `
                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 1.25rem; border-radius: 0.75rem; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Open Tickets</div>
                        <div style="font-size: 2rem; font-weight: 700;">${stats.open}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 1.25rem; border-radius: 0.75rem; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">In Progress</div>
                        <div style="font-size: 2rem; font-weight: 700;">${stats.in_progress}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 1.25rem; border-radius: 0.75rem; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Resolved</div>
                        <div style="font-size: 2rem; font-weight: 700;">${stats.resolved}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 1.25rem; border-radius: 0.75rem; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Tickets</div>
                        <div style="font-size: 2rem; font-weight: 700;">${stats.total}</div>
                    </div>
                </div>

                <!-- Create Ticket Form (Always Visible at Top) -->
                <div id="createTicketForm" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.05)); border: 2px solid #8b5cf6; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: var(--text-primary); font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-plus-circle" style="color: #8b5cf6;"></i> Create New Support Ticket
                        </h3>
                        <button id="toggleFormBtn" onclick="toggleCreateTicketForm()" style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem; padding: 0.5rem; transition: all 0.2s;">
                            <i class="fas fa-chevron-up" id="toggleFormIcon"></i>
                        </button>
                    </div>
                    
                    <div id="ticketFormFields" style="display: block;">
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid #8b5cf6;">
                            <div style="display: flex; align-items: start; gap: 0.75rem;">
                                <i class="fas fa-info-circle" style="color: #8b5cf6; font-size: 1.25rem; margin-top: 0.125rem;"></i>
                                <div>
                                    <p style="margin: 0; color: var(--text-primary); font-weight: 600; font-size: 0.875rem;">Need Help?</p>
                                    <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">Fill out the form below to create a support ticket. Our team will respond within 24 hours.</p>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                    <i class="fas fa-heading"></i> Subject * 
                                    <span style="color: var(--text-secondary); font-weight: 400; font-size: 0.75rem;">(Brief description of your issue)</span>
                                </label>
                                <input type="text" id="ticketSubject" placeholder="e.g., Payment not processing for property booking" style="width: 100%; padding: 0.875rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                        <i class="fas fa-tags"></i> Category *
                                    </label>
                                    <select id="ticketCategory" style="width: 100%; padding: 0.875rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                                        <option value="general">üí¨ General Inquiry</option>
                                        <option value="payment">üí≥ Payment Issue</option>
                                        <option value="property">üè† Property Related</option>
                                        <option value="technical">üîß Technical Support</option>
                                    </select>
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                        <i class="fas fa-exclamation-circle"></i> Priority *
                                    </label>
                                    <select id="ticketPriority" style="width: 100%; padding: 0.875rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                                        <option value="low">üü¢ Low - General question</option>
                                        <option value="medium" selected>üîµ Medium - Need assistance</option>
                                        <option value="high">üü° High - Issue affecting use</option>
                                        <option value="urgent">üî¥ Urgent - Critical problem</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                    <i class="fas fa-align-left"></i> Description * 
                                    <span style="color: var(--text-secondary); font-weight: 400; font-size: 0.75rem;">(Explain your issue in detail)</span>
                                </label>
                                <textarea id="ticketDescription" placeholder="Please provide as much detail as possible about your issue:
‚Ä¢ What were you trying to do?
‚Ä¢ What happened instead?
‚Ä¢ Have you tried any solutions?
‚Ä¢ Any error messages you saw?" rows="6" style="width: 100%; padding: 0.875rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem; resize: vertical; line-height: 1.6;"></textarea>
                            </div>

                            <div style="display: flex; gap: 1rem;">
                                <button onclick="submitSupportTicket()" style="flex: 1; padding: 1rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(16, 185, 129, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                    <i class="fas fa-paper-plane"></i> Submit Support Ticket
                                </button>
                                <button onclick="clearTicketForm()" style="padding: 1rem 1.5rem; background: var(--input-bg); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#ef4444'; this.style.color='#ef4444';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-secondary)';">
                                    <i class="fas fa-eraser"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                ${tickets.length > 0 ? '<h3 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-list"></i> Your Support Tickets</h3>' : ''}

                <!-- Tickets List -->
                <div style="display: grid; gap: 1rem;">
            `;
            
            if (tickets.length === 0) {
                html += `
                    <div style="text-align: center; padding: 2rem; background: var(--bg-secondary); border-radius: 1rem; border: 2px dashed var(--border-color);">
                        <div style="font-size: 3rem; color: #94a3b8; margin-bottom: 1rem;">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">No Support Tickets Yet</h3>
                        <p style="color: var(--text-secondary);">Create your first ticket above to get help from our support team</p>
                    </div>
                `;
            } else {
                tickets.forEach(ticket => {
                    const statusColors = {
                        'open': { bg: '#10b981', text: '#10b981', icon: 'envelope-open' },
                        'in_progress': { bg: '#f59e0b', text: '#f59e0b', icon: 'spinner' },
                        'resolved': { bg: '#3b82f6', text: '#3b82f6', icon: 'check-circle' },
                        'closed': { bg: '#6b7280', text: '#6b7280', icon: 'times-circle' }
                    };
                    
                    const priorityColors = {
                        'low': '#6b7280',
                        'medium': '#3b82f6',
                        'high': '#f59e0b',
                        'urgent': '#ef4444'
                    };
                    
                    const categoryIcons = {
                        'general': 'info-circle',
                        'payment': 'credit-card',
                        'property': 'home',
                        'technical': 'wrench'
                    };
                    
                    const status = statusColors[ticket.status] || statusColors['open'];
                    const priorityColor = priorityColors[ticket.priority] || priorityColors['medium'];
                    const categoryIcon = categoryIcons[ticket.category] || categoryIcons['general'];
                    
                    html += `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; transition: all 0.2s; border-left: 4px solid ${status.bg};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                        <span style="background: ${status.bg}20; color: ${status.text}; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: inline-flex; align-items: center; gap: 0.375rem;">
                                            <i class="fas fa-${status.icon}"></i> ${ticket.status.replace('_', ' ')}
                                        </span>
                                        <span style="background: ${priorityColor}20; color: ${priorityColor}; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                                            ${ticket.priority}
                                        </span>
                                        <!-- Token ID Badge (Prominent Display) -->
                                        <span style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 700; font-family: 'Courier New', monospace; letter-spacing: 0.05em; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3); display: inline-flex; align-items: center; gap: 0.5rem;">
                                            <i class="fas fa-ticket-alt"></i> ${ticket.token_id}
                                        </span>
                                    </div>
                                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-${categoryIcon}" style="color: #8b5cf6;"></i> ${ticket.subject}
                                    </h3>
                                </div>
                            </div>

                            <p style="color: var(--text-secondary); font-size: 0.875rem; line-height: 1.6; margin-bottom: 1rem;">
                                ${ticket.description.length > 200 ? ticket.description.substring(0, 200) + '...' : ticket.description}
                            </p>

                            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                <div style="display: flex; gap: 1.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                                    <div title="Created on ${ticket.created_at}">
                                        <i class="far fa-calendar-alt"></i> ${new Date(ticket.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                                    </div>
                                    <div>
                                        <i class="fas fa-tag"></i> ${ticket.category}
                                    </div>
                                    ${ticket.response_count > 0 ? `
                                    <div style="color: #10b981; font-weight: 600;">
                                        <i class="fas fa-comments"></i> ${ticket.response_count} response${ticket.response_count > 1 ? 's' : ''}
                                    </div>
                                    ` : ''}
                                </div>
                                <button onclick="copyTicketToken('${ticket.token_id}')" style="background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.color='#8b5cf6'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-primary)'">
                                    <i class="fas fa-copy"></i> Copy Token
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `
                </div>
            `;
            
            content.innerHTML = html;
        }

        function toggleCreateTicketForm() {
            const fields = document.getElementById('ticketFormFields');
            const icon = document.getElementById('toggleFormIcon');
            
            if (fields.style.display === 'none') {
                fields.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                fields.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        function copyTicketToken(tokenId) {
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            
            navigator.clipboard.writeText(tokenId).then(() => {
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.style.background = 'rgba(16, 185, 129, 0.1)';
                btn.style.borderColor = '#10b981';
                btn.style.color = '#10b981';
                
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.style.background = 'var(--input-bg)';
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.color = 'var(--text-primary)';
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Could not copy token ID. Please copy manually: ' + tokenId);
            });
        }

        function clearTicketForm() {
            document.getElementById('ticketSubject').value = '';
            document.getElementById('ticketCategory').value = 'general';
            document.getElementById('ticketPriority').value = 'medium';
            document.getElementById('ticketDescription').value = '';
        }

        function showCreateTicketForm() {
            const form = document.getElementById('createTicketForm');
            const fields = document.getElementById('ticketFormFields');
            const icon = document.getElementById('toggleFormIcon');
            
            if (form) {
                fields.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function hideCreateTicketForm() {
            // Not needed anymore since form is always visible but can be collapsed
            const fields = document.getElementById('ticketFormFields');
            const icon = document.getElementById('toggleFormIcon');
            
            if (fields && fields.style.display === 'block') {
                fields.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
            clearTicketForm();
        }

        // Chat Interface Functions
        let selectedCategory = null;
        let chatConversationStarted = false;

        function selectIssueType(category) {
            selectedCategory = category;
            chatConversationStarted = true;

            // Map category to display text
            const categoryMap = {
                'payment': 'üí≥ Payment Issue',
                'property': 'üè† Property Question',
                'technical': 'üîß Technical Support',
                'general': 'üí¨ General Question'
            };

            // Add user's selection as message
            addChatMessage(categoryMap[category], 'user');

            // Show typing indicator
            document.getElementById('typingIndicator').style.display = 'flex';

            // Bot responds after delay
            setTimeout(() => {
                document.getElementById('typingIndicator').style.display = 'none';
                
                const responses = {
                    'payment': 'I understand you have a payment-related question. Please describe your issue in detail, and I\'ll make sure our team gets back to you quickly.',
                    'property': 'I\'m here to help with your property inquiry. Please provide details about the property or your question.',
                    'technical': 'I see you\'re experiencing a technical issue. Please describe what\'s happening, and I\'ll escalate this to our technical team.',
                    'general': 'Thank you for reaching out! Please tell me how I can assist you today.'
                };

                addChatMessage(responses[category], 'bot');
                
                // Focus on input and hide quick actions
                document.getElementById('chatMessageInput').focus();
                document.querySelectorAll('.chat-quick-action').forEach(btn => {
                    btn.style.display = 'none';
                });
            }, 1200);
        }

        function sendChatMessage() {
            const input = document.getElementById('chatMessageInput');
            const message = input.value.trim();

            if (!message) {
                alert('‚ö†Ô∏è Please enter a message');
                return;
            }

            if (message.length < 10) {
                alert('‚ö†Ô∏è Please provide more details (at least 10 characters)');
                return;
            }

            if (!selectedCategory) {
                alert('‚ö†Ô∏è Please select an issue type first');
                return;
            }

            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            autoResizeChatInput(input);

            // Show typing indicator
            document.getElementById('typingIndicator').style.display = 'flex';

            // Submit ticket via API
            fetch('/backend/api/buyer/support-tickets/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    subject: selectedCategory.charAt(0).toUpperCase() + selectedCategory.slice(1) + ' Support',
                    category: selectedCategory,
                    priority: 'medium',
                    description: message
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('typingIndicator').style.display = 'none';

                if (data.success) {
                    // Bot confirms ticket creation
                    addChatMessage(
                        `‚úÖ Your support ticket has been created successfully!<br><br>` +
                        `<strong>Token ID: <span style="color: #10b981; font-family: 'Courier New', monospace; font-size: 1.1em;">${data.token_id}</span></strong><br><br>` +
                        `Our team will review your request and respond within 24 hours. You can track your ticket using this token ID.`,
                        'bot'
                    );

                    // Show beautiful token modal after a delay
                    setTimeout(() => {
                        showTokenSuccessMessage(data.token_id, data.ticket_id);
                        
                        // Reload tickets list
                        setTimeout(() => {
                            loadSupportTickets();
                        }, 1500);
                    }, 1000);

                    // Reset chat state
                    selectedCategory = null;
                    chatConversationStarted = false;
                    
                    // Hide input area and show quick actions again
                    setTimeout(() => {
                        document.getElementById('chatInputArea').style.display = 'none';
                        document.querySelectorAll('.chat-quick-action').forEach(btn => {
                            btn.style.display = 'inline-flex';
                        });
                    }, 2000);
                } else {
                    addChatMessage(
                        `‚ùå Sorry, there was an error creating your ticket: ${data.error || 'Unknown error'}. Please try again.`,
                        'bot'
                    );
                }
            })
            .catch(error => {
                document.getElementById('typingIndicator').style.display = 'none';
                console.error('Error:', error);
                addChatMessage(
                    '‚ùå An error occurred while submitting your request. Please try again later or contact us directly.',
                    'bot'
                );
            });
        }

        function addChatMessage(message, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            if (sender === 'user') {
                messageDiv.style.cssText = 'display: flex; justify-content: flex-end; margin-bottom: 1rem; animation: fadeIn 0.3s ease;';
                messageDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 0.875rem 1.25rem; border-radius: 1.25rem 1.25rem 0.25rem 1.25rem; max-width: 70%; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);">
                        <div style="font-size: 0.95rem; line-height: 1.6; word-wrap: break-word;">${message}</div>
                        <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.5rem; text-align: right;">${timestamp}</div>
                    </div>
                `;
            } else {
                messageDiv.style.cssText = 'display: flex; justify-content: flex-start; margin-bottom: 1rem; animation: fadeIn 0.3s ease;';
                messageDiv.innerHTML = `
                    <div style="display: flex; gap: 0.75rem; max-width: 75%;">
                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-robot" style="color: white; font-size: 0.875rem;"></i>
                        </div>
                        <div>
                            <div style="background: var(--bg-secondary); color: var(--text-primary); padding: 0.875rem 1.25rem; border-radius: 1.25rem 1.25rem 1.25rem 0.25rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                                <div style="font-size: 0.95rem; line-height: 1.6; word-wrap: break-word;">${message}</div>
                            </div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.375rem; padding-left: 0.5rem;">${timestamp}</div>
                        </div>
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            scrollChatToBottom();
        }

        function scrollChatToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        function autoResizeChatInput(textarea) {
            textarea.style.height = '24px';
            const newHeight = Math.min(Math.max(textarea.scrollHeight, 24), 120);
            textarea.style.height = newHeight + 'px';
        }

        function handleChatInputKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function attachFile() {
            alert('üìé File attachment feature coming soon! For now, please describe your issue in the message.');
        }

        function closeSupportChatModal() {
            const modal = document.getElementById('supportTicketsModal');
            modal.style.display = 'none';
            
            // Reset chat state
            selectedCategory = null;
            chatConversationStarted = false;
            
            // Clear messages except welcome message
            const messagesContainer = document.getElementById('chatMessages');
            const welcomeMessage = messagesContainer.querySelector('[data-welcome]');
            messagesContainer.innerHTML = '';
            if (welcomeMessage) {
                messagesContainer.appendChild(welcomeMessage);
            }
            
            // Reset input
            const input = document.getElementById('chatMessageInput');
            input.value = '';
            autoResizeChatInput(input);
            
            // Show quick actions again
            document.querySelectorAll('.chat-quick-action').forEach(btn => {
                btn.style.display = 'inline-flex';
            });
            
            // Hide typing indicator
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // Legacy form-based function (kept for old tickets list functionality)
        function submitSupportTicket() {
            const subject = document.getElementById('ticketSubject').value.trim();
            const category = document.getElementById('ticketCategory').value;
            const priority = document.getElementById('ticketPriority').value;
            const description = document.getElementById('ticketDescription').value.trim();
            
            // Validation
            if (!subject) {
                alert('‚ö†Ô∏è Please enter a subject for your ticket');
                document.getElementById('ticketSubject').focus();
                return;
            }
            
            if (subject.length < 10) {
                alert('‚ö†Ô∏è Subject should be at least 10 characters long');
                document.getElementById('ticketSubject').focus();
                return;
            }
            
            if (!description) {
                alert('‚ö†Ô∏è Please enter a description of your issue');
                document.getElementById('ticketDescription').focus();
                return;
            }
            
            if (description.length < 20) {
                alert('‚ö†Ô∏è Please provide more details (at least 20 characters)');
                document.getElementById('ticketDescription').focus();
                return;
            }
            
            // Disable submit button
            const submitBtn = event.target;
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Ticket...';
            
            // Submit ticket
            fetch('/backend/api/buyer/support-tickets/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    subject: subject,
                    category: category,
                    priority: priority,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show beautiful token success message
                    showTokenSuccessMessage(data.token_id, data.ticket_id);
                    
                    // Clear form
                    clearTicketForm();
                    
                    // Reload tickets list after a short delay
                    setTimeout(() => {
                        loadSupportTickets();
                    }, 1500);
                } else {
                    alert('‚ùå Error creating ticket: ' + (data.error || 'Unknown error'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå An error occurred while creating the ticket. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        }

        function showTokenSuccessMessage(tokenId, ticketId) {
            // Create success overlay
            const overlay = document.createElement('div');
            overlay.id = 'tokenSuccessOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;';
            
            const successBox = document.createElement('div');
            successBox.style.cssText = 'background: var(--bg-primary); border-radius: 1.5rem; padding: 3rem; max-width: 500px; text-align: center; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); animation: scaleIn 0.3s ease; border: 2px solid #10b981;';
            
            successBox.innerHTML = `
                <div style="font-size: 4rem; color: #10b981; margin-bottom: 1.5rem; animation: bounce 0.6s ease;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 style="color: var(--text-primary); font-size: 1.875rem; font-weight: 700; margin-bottom: 1rem;">
                    Ticket Created Successfully! üéâ
                </h2>
                <p style="color: var(--text-secondary); margin-bottom: 2rem; font-size: 1rem;">
                    Your support ticket has been submitted. Please save this token ID for tracking:
                </p>
                
                <!-- Token ID Display -->
                <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: shimmer 3s infinite;"></div>
                    <div style="font-size: 0.875rem; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600;">Your Token ID</div>
                    <div style="font-size: 2.5rem; font-weight: 900; color: white; letter-spacing: 0.05em; font-family: 'Courier New', monospace; margin-bottom: 0.75rem; position: relative; z-index: 1;">
                        ${tokenId}
                    </div>
                    <button onclick="copyTokenId('${tokenId}')" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1.25rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; position: relative; z-index: 1;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        <i class="fas fa-copy"></i> Copy Token ID
                    </button>
                </div>
                
                <div style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; text-align: left;">
                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                        <i class="fas fa-info-circle" style="color: #3b82f6; font-size: 1.25rem; margin-top: 0.125rem;"></i>
                        <div>
                            <p style="margin: 0; color: var(--text-primary); font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Important:</p>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem; line-height: 1.6;">
                                ‚Ä¢ Use this Token ID to track your ticket<br>
                                ‚Ä¢ Our team will respond within 24 hours<br>
                                ‚Ä¢ You'll receive a notification when resolved<br>
                                ‚Ä¢ Keep this Token ID for future reference
                            </p>
                        </div>
                    </div>
                </div>
                
                <button onclick="closeTokenSuccessMessage()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 1rem 2.5rem; border-radius: 0.75rem; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(139, 92, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.3)'">
                    <i class="fas fa-check"></i> Got It!
                </button>
            `;
            
            overlay.appendChild(successBox);
            document.body.appendChild(overlay);
        }

        function copyTokenId(tokenId) {
            navigator.clipboard.writeText(tokenId).then(() => {
                // Show temporary success message
                const btn = event.target.closest('button');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.style.background = 'rgba(16, 185, 129, 0.3)';
                btn.style.borderColor = '#10b981';
                
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.style.background = 'rgba(255,255,255,0.2)';
                    btn.style.borderColor = 'rgba(255,255,255,0.3)';
                }, 2000);
            }).catch(err => {
                alert('Could not copy token ID. Please copy it manually: ' + tokenId);
            });
        }

        function closeTokenSuccessMessage() {
            const overlay = document.getElementById('tokenSuccessOverlay');
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        function closeSupportTicketsModal() {
            const modal = document.getElementById('supportTicketsModal');
            modal.style.display = 'none';
            hideCreateTicketForm();
        }

        // Reviews & Feedback Functions
        function loadReviews() {
            const modal = document.getElementById('reviewsModal');
            const loading = document.getElementById('reviewsLoading');
            const content = document.getElementById('reviewsContent');
            
            // Show modal
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.style.display = 'none';
            
            // Fetch reviews
            fetch('/backend/api/buyer/reviews/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loading.style.display = 'none';
                    console.log('Reviews data:', data);
                    
                    if (data.success) {
                        displayReviews(data.reviews, data.stats);
                        content.style.display = 'block';
                    } else {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #ef4444;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>Error: ${data.error || 'Unknown error occurred'}</p>
                                <button onclick="loadReviews()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #f59e0b; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">Try Again</button>
                            </div>
                        `;
                        content.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading reviews:', error);
                    loading.style.display = 'none';
                    content.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Error loading reviews: ${error.message}</p>
                            <button onclick="loadReviews()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #f59e0b; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">Try Again</button>
                        </div>
                    `;
                    content.style.display = 'block';
                });
        }

        function displayReviews(reviews, stats) {
            const content = document.getElementById('reviewsContent');
            
            let html = `
                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 1.5rem; border-radius: 0.75rem; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Reviews</div>
                                <div style="font-size: 2.5rem; font-weight: 700;">${stats.total}</div>
                            </div>
                            <i class="fas fa-star" style="font-size: 2rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 1.5rem; border-radius: 0.75rem; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Average Rating</div>
                                <div style="font-size: 2.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.25rem;">
                                    ${stats.average_rating} <span style="font-size: 1.5rem;">‚òÖ</span>
                                </div>
                            </div>
                            <i class="fas fa-award" style="font-size: 2rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>

                <!-- Create Review Section -->
                <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05)); border: 2px solid #f59e0b; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: var(--text-primary); font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-pen-fancy" style="color: #f59e0b;"></i> Write a New Review
                        </h3>
                    </div>

                    <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; align-items: start; gap: 0.75rem;">
                            <i class="fas fa-lightbulb" style="color: #f59e0b; font-size: 1.25rem; margin-top: 0.125rem;"></i>
                            <div>
                                <p style="margin: 0; color: var(--text-primary); font-weight: 600; font-size: 0.875rem;">Share Your Experience!</p>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">Help other buyers by reviewing properties you've visited or booked.</p>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; gap: 1.25rem;">
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                <i class="fas fa-home"></i> Select Property *
                            </label>
                            <select id="reviewPropertyId" style="width: 100%; padding: 0.875rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                                <option value="">-- Select a property to review --</option>
                            </select>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                <i class="fas fa-info-circle"></i> Only properties you've booked will appear here
                            </div>
                        </div>

                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                <i class="fas fa-star"></i> Rating * <span id="ratingValue" style="color: #f59e0b; font-size: 1.25rem; margin-left: 0.5rem;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                ${[1, 2, 3, 4, 5].map(star => `
                                    <button type="button" onclick="setRating(${star})" class="star-btn" data-rating="${star}" style="background: none; border: none; font-size: 2.5rem; color: #fbbf24; cursor: pointer; transition: all 0.2s; padding: 0;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                                        ‚òÖ
                                    </button>
                                `).join('')}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                1‚òÖ = Poor, 2‚òÖ = Fair, 3‚òÖ = Good, 4‚òÖ = Very Good, 5‚òÖ = Excellent
                            </div>
                        </div>

                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                <i class="fas fa-heading"></i> Review Title
                            </label>
                            <input type="text" id="reviewTitle" placeholder="e.g., Great property with excellent location!" style="width: 100%; padding: 0.875rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem;">
                        </div>

                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                <i class="fas fa-comment-alt"></i> Your Review * (Minimum 20 characters)
                            </label>
                            <textarea id="reviewText" placeholder="Share your detailed experience with this property..." rows="4" style="width: 100%; padding: 0.875rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem; resize: vertical;"></textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                    <i class="fas fa-thumbs-up" style="color: #10b981;"></i> What you liked (Pros)
                                </label>
                                <textarea id="reviewPros" placeholder="Location, amenities, space..." rows="3" style="width: 100%; padding: 0.875rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem; resize: vertical;"></textarea>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                                    <i class="fas fa-thumbs-down" style="color: #ef4444;"></i> What could be better (Cons)
                                </label>
                                <textarea id="reviewCons" placeholder="Any areas for improvement..." rows="3" style="width: 100%; padding: 0.875rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 0.875rem; resize: vertical;"></textarea>
                            </div>
                        </div>

                        <div style="background: var(--input-bg); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                <input type="checkbox" id="wouldRecommend" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 600; color: var(--text-primary);"><i class="fas fa-thumbs-up" style="color: #10b981;"></i> I would recommend this property to others</span>
                            </label>
                        </div>

                        <div style="display: flex; gap: 1rem;">
                            <button onclick="submitReview()" style="flex: 1; padding: 1rem; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(245, 158, 11, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <i class="fas fa-paper-plane"></i> Submit Review
                            </button>
                            <button onclick="clearReviewForm()" style="padding: 1rem 1.5rem; background: var(--input-bg); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                ${reviews.length > 0 ? '<h3 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-list-stars"></i> Your Reviews</h3>' : ''}

                <!-- Reviews List -->
                <div style="display: grid; gap: 1.5rem;">
            `;

            if (reviews.length === 0) {
                html += `
                    <div style="text-align: center; padding: 2rem; background: var(--bg-secondary); border-radius: 1rem; border: 2px dashed var(--border-color);">
                        <div style="font-size: 3rem; color: #94a3b8; margin-bottom: 1rem;">
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">No Reviews Yet</h3>
                        <p style="color: var(--text-secondary);">Write your first property review above!</p>
                    </div>
                `;
            } else {
                reviews.forEach(review => {
                    const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
                    
                    html += `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 0.5rem 0; font-size: 1.125rem; font-weight: 600; color: var(--text-primary);">
                                        <i class="fas fa-home" style="color: #f59e0b;"></i> ${review.property_title}
                                    </h4>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <div style="color: #fbbf24; font-size: 1.25rem;">${stars}</div>
                                        <span style="color: var(--text-secondary); font-size: 0.875rem;">(${review.rating}/5)</span>
                                    </div>
                                    ${review.title ? `
                                        <div style="font-weight: 600; color: var(--text-primary); font-size: 1rem; margin-bottom: 0.5rem;">"${review.title}"</div>
                                    ` : ''}
                                </div>
                                <div style="text-align: right;">
                                    ${review.is_verified ? `
                                        <span style="background: #10b98120; color: #10b981; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.25rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-check-circle"></i> Verified
                                        </span><br>
                                    ` : ''}
                                    ${review.would_recommend ? `
                                        <span style="background: #3b82f620; color: #3b82f6; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.25rem;">
                                            <i class="fas fa-thumbs-up"></i> Recommends
                                        </span>
                                    ` : ''}
                                </div>
                            </div>

                            <p style="color: var(--text-secondary); font-size: 0.875rem; line-height: 1.6; margin-bottom: 1rem;">
                                ${review.review_text}
                            </p>

                            ${review.pros || review.cons ? `
                                <div style="display: grid; grid-template-columns: ${review.pros && review.cons ? '1fr 1fr' : '1fr'}; gap: 1rem; margin-bottom: 1rem;">
                                    ${review.pros ? `
                                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #10b981;">
                                            <div style="font-weight: 600; color: #10b981; font-size: 0.875rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="fas fa-plus-circle"></i> Pros
                                            </div>
                                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem; line-height: 1.5;">${review.pros}</p>
                                        </div>
                                    ` : ''}
                                    ${review.cons ? `
                                        <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #ef4444;">
                                            <div style="font-weight: 600; color: #ef4444; font-size: 0.875rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="fas fa-minus-circle"></i> Cons
                                            </div>
                                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem; line-height: 1.5;">${review.cons}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}

                            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color); font-size: 0.875rem; color: var(--text-secondary);">
                                <div style="display: flex; gap: 1rem;">
                                    <div><i class="far fa-calendar"></i> ${new Date(review.created_at).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'})}</div>
                                    <div><i class="fas fa-map-marker-alt"></i> ${review.property_location}</div>
                                </div>
                                ${review.helpful_votes > 0 ? `
                                    <div><i class="fas fa-heart"></i> ${review.helpful_votes} found helpful</div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            html += `
                </div>
            `;

            content.innerHTML = html;
            
            // Load properties for dropdown
            loadPropertiesForReview();
        }

        let selectedRating = 5;

        function setRating(rating) {
            selectedRating = rating;
            const ratingValue = document.getElementById('ratingValue');
            ratingValue.textContent = '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
            
            // Update star button colors
            document.querySelectorAll('.star-btn').forEach((btn, index) => {
                if (index < rating) {
                    btn.style.color = '#fbbf24';
                } else {
                    btn.style.color = '#cbd5e1';
                }
            });
        }

        function loadPropertiesForReview() {
            // Fetch user's booked properties that can be reviewed
            fetch('/backend/api/buyer/reviewable-properties/')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('reviewPropertyId');
                    
                    if (data.success && data.properties && data.properties.length > 0) {
                        // Group properties into reviewed and not reviewed
                        const notReviewed = data.properties.filter(p => !p.already_reviewed);
                        const alreadyReviewed = data.properties.filter(p => p.already_reviewed);
                        
                        select.innerHTML = '<option value="">-- Select a property to review --</option>';
                        
                        // Add properties that haven't been reviewed yet
                        if (notReviewed.length > 0) {
                            notReviewed.forEach(property => {
                                const option = document.createElement('option');
                                option.value = property.property_id;
                                option.textContent = `${property.title} - ${property.location} (${property.property_type})`;
                                select.appendChild(option);
                            });
                        }
                        
                        // Add separator if there are reviewed properties
                        if (alreadyReviewed.length > 0 && notReviewed.length > 0) {
                            const separator = document.createElement('option');
                            separator.disabled = true;
                            separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Already Reviewed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                            select.appendChild(separator);
                        }
                        
                        // Add already reviewed properties (disabled)
                        if (alreadyReviewed.length > 0) {
                            alreadyReviewed.forEach(property => {
                                const option = document.createElement('option');
                                option.value = property.property_id;
                                option.disabled = true;
                                option.textContent = `${property.title} - ${property.location} ‚úì Reviewed`;
                                option.style.color = '#94a3b8';
                                select.appendChild(option);
                            });
                        }
                        
                        // Show message if all properties are already reviewed
                        if (notReviewed.length === 0) {
                            const noMoreOption = document.createElement('option');
                            noMoreOption.value = '';
                            noMoreOption.textContent = '‚úì You have reviewed all your booked properties!';
                            select.appendChild(noMoreOption);
                        }
                    } else {
                        // No properties available
                        select.innerHTML = '<option value="">-- Select a property to review --</option><option value="">üìã No properties available yet</option><option value="">üí° Book a property first to leave a review</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading properties:', error);
                    const select = document.getElementById('reviewPropertyId');
                    select.innerHTML = '<option value="">-- Select a property to review --</option><option value="">‚ùå Error loading properties</option>';
                });
        }

        function clearReviewForm() {
            document.getElementById('reviewPropertyId').value = '';
            document.getElementById('reviewTitle').value = '';
            document.getElementById('reviewText').value = '';
            document.getElementById('reviewPros').value = '';
            document.getElementById('reviewCons').value = '';
            document.getElementById('wouldRecommend').checked = true;
            setRating(5);
        }

        function submitReview() {
            const propertyId = document.getElementById('reviewPropertyId').value;
            const title = document.getElementById('reviewTitle').value.trim();
            const reviewText = document.getElementById('reviewText').value.trim();
            const pros = document.getElementById('reviewPros').value.trim();
            const cons = document.getElementById('reviewCons').value.trim();
            const wouldRecommend = document.getElementById('wouldRecommend').checked;
            
            // Validation
            if (!propertyId) {
                alert('‚ö†Ô∏è Please select a property to review');
                return;
            }
            
            if (!reviewText) {
                alert('‚ö†Ô∏è Please write your review');
                document.getElementById('reviewText').focus();
                return;
            }
            
            if (reviewText.length < 20) {
                alert('‚ö†Ô∏è Review must be at least 20 characters long');
                document.getElementById('reviewText').focus();
                return;
            }
            
            // Submit review
            fetch('/backend/api/buyer/reviews/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    property_id: propertyId,
                    rating: selectedRating,
                    title: title,
                    review_text: reviewText,
                    pros: pros,
                    cons: cons,
                    would_recommend: wouldRecommend
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Review submitted successfully!\\n\\nThank you for sharing your experience. Your review will help other buyers make informed decisions.');
                    clearReviewForm();
                    loadReviews();
                } else {
                    alert('‚ùå Error submitting review: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå An error occurred while submitting your review. Please try again.');
            });
        }

        function closeReviewsModal() {
            const modal = document.getElementById('reviewsModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const savedModal = document.getElementById('savedPropertiesModal');
            const paymentModal = document.getElementById('paymentHistoryModal');
            const marketModal = document.getElementById('marketInsightsModal');
            const supportModal = document.getElementById('supportTicketsModal');
            const reviewsModal = document.getElementById('reviewsModal');
            
            if (event.target === savedModal) {
                closeSavedPropertiesModal();
            }
            if (event.target === paymentModal) {
                closePaymentHistoryModal();
            }
            if (event.target === marketModal) {
                closeMarketInsightsModal();
            }
            if (event.target === supportModal) {
                closeSupportTicketsModal();
            }
            if (event.target === reviewsModal) {
                closeReviewsModal();
            }
        }
        
        // ===========================
        // NOTIFICATION SYSTEM
        // ===========================
        
        // Load notifications on page load
        loadNotifications();
        // Refresh notifications every 30 seconds
        setInterval(loadNotifications, 30000);
        
        function loadNotifications() {
            fetch('/backend/api/notifications/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateNotificationBadge(data.unread_count);
                        window.userNotifications = data.notifications;
                    }
                })
                .catch(error => console.error('Error loading notifications:', error));
        }
        
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            if (!panel) {
                createNotificationPanel();
            } else {
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
                if (panel.style.display === 'block') displayNotifications();
            }
        }
        
        function createNotificationPanel() {
            const panel = document.createElement('div');
            panel.id = 'notificationPanel';
            panel.className = 'notification-panel';
            panel.innerHTML = `
                <div class="notification-panel-header">
                    <h3><i class="fas fa-bell"></i> Notifications</h3>
                    <div class="notification-panel-actions">
                        <button onclick="markAllAsRead()" class="mark-all-read-btn" title="Mark all as read">
                            <i class="fas fa-check-double"></i>
                        </button>
                        <button onclick="toggleNotificationPanel()" class="close-panel-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="notification-panel-body" id="notificationPanelBody">
                    <div class="notification-loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            `;
            document.body.appendChild(panel);
            displayNotifications();
        }
        
        function displayNotifications() {
            const body = document.getElementById('notificationPanelBody');
            const notifications = window.userNotifications || [];
            
            if (notifications.length === 0) {
                body.innerHTML = `<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No notifications yet</p></div>`;
                return;
            }
            
            let html = '';
            notifications.forEach(notif => {
                const readClass = notif.is_read ? 'notification-read' : 'notification-unread';
                const icon = getNotificationIcon(notif.type);
                html += `
                    <div class="notification-item ${readClass}" onclick="markNotificationAsRead(${notif.notification_id})">
                        <div class="notification-icon ${notif.type}"><i class="${icon}"></i></div>
                        <div class="notification-content">
                            <div class="notification-title">${notif.title}</div>
                            <div class="notification-message">${notif.message}</div>
                            <div class="notification-time"><i class="fas fa-clock"></i> ${notif.time_ago}</div>
                        </div>
                        ${!notif.is_read ? '<div class="notification-unread-dot"></div>' : ''}
                    </div>
                `;
            });
            body.innerHTML = html;
        }
        
        function getNotificationIcon(type) {
            const icons = {
                'booking_confirmed': 'fas fa-check-circle',
                'booking_cancelled': 'fas fa-times-circle',
                'booking_pending': 'fas fa-clock',
                'booking_completed': 'fas fa-flag-checkered',
                'payment_received': 'fas fa-money-check-alt',
                'property_updated': 'fas fa-home',
                'default': 'fas fa-info-circle'
            };
            return icons[type] || icons['default'];
        }
        
        function markNotificationAsRead(notificationId) {
            fetch(`/backend/api/notifications/${notificationId}/mark-read/`, {method: 'POST'})
            .then(response => response.json())
            .then(data => { if (data.success) { loadNotifications(); displayNotifications(); } })
            .catch(error => console.error('Error:', error));
        }
        
        function markAllAsRead() {
            fetch('/backend/api/notifications/mark-all-read/', {method: 'POST'})
            .then(response => response.json())
            .then(data => { if (data.success) { loadNotifications(); displayNotifications(); alert(`‚úÖ ${data.updated_count} notification(s) marked as read`); } })
            .catch(error => console.error('Error:', error));
        }
        
        // Close panel when clicking outside
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('notificationPanel');
            const btn = document.getElementById('notificationBtn');
            if (panel && panel.style.display === 'block' && !panel.contains(event.target) && event.target !== btn && !btn.contains(event.target)) {
                panel.style.display = 'none';
            }
        });
    </script>
    
    <style>
        .notification-panel{position:fixed;top:5rem;right:2rem;width:400px;max-width:calc(100vw - 4rem);max-height:600px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.4);z-index:10000;display:none;overflow:hidden;animation:slideInRight 0.3s ease-out;backdrop-filter:blur(20px)}@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}.notification-panel-header{background:linear-gradient(135deg,var(--primary-blue) 0%,var(--secondary-indigo) 100%);color:white;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.1)}.notification-panel-header h3{margin:0;font-size:1.125rem;font-weight:600;display:flex;align-items:center;gap:0.5rem}.notification-panel-actions{display:flex;gap:0.5rem}.mark-all-read-btn,.close-panel-btn{background:rgba(255,255,255,0.2);border:none;color:white;width:2rem;height:2rem;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}.mark-all-read-btn:hover,.close-panel-btn:hover{background:rgba(255,255,255,0.3);transform:scale(1.1)}.notification-panel-body{max-height:550px;overflow-y:auto;background:var(--bg-primary)}.notification-panel-body::-webkit-scrollbar{width:6px}.notification-panel-body::-webkit-scrollbar-track{background:var(--bg-secondary)}.notification-panel-body::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}.notification-item{padding:1rem 1.5rem;border-bottom:1px solid var(--border-color);cursor:pointer;transition:all 0.2s;display:flex;gap:1rem;position:relative}.notification-item:hover{background:var(--bg-secondary)}.notification-unread{background:rgba(59,130,246,0.05)}.notification-read{opacity:0.7}.notification-icon{width:2.5rem;height:2.5rem;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1.125rem;color:white}.notification-icon.booking_confirmed{background:linear-gradient(135deg,var(--success-green),#059669)}.notification-icon.booking_cancelled{background:linear-gradient(135deg,var(--error-red),#dc2626)}.notification-icon.booking_pending{background:linear-gradient(135deg,var(--warning-orange),#d97706)}.notification-icon.booking_completed{background:linear-gradient(135deg,var(--accent-purple),#7c3aed)}.notification-icon.payment_received{background:linear-gradient(135deg,var(--success-green),#34d399)}.notification-icon.property_updated{background:linear-gradient(135deg,var(--primary-blue),var(--secondary-indigo))}.notification-content{flex:1}.notification-title{font-weight:600;font-size:0.9375rem;color:var(--text-primary);margin-bottom:0.25rem}.notification-message{font-size:0.875rem;color:var(--text-secondary);line-height:1.4;margin-bottom:0.5rem}.notification-time{font-size:0.75rem;color:var(--text-muted);display:flex;align-items:center;gap:0.25rem}.notification-unread-dot{width:8px;height:8px;background:var(--primary-blue);border-radius:50%;position:absolute;top:1rem;right:1rem}.notification-empty,.notification-loading{padding:3rem 2rem;text-align:center;color:var(--text-secondary)}.notification-empty i,.notification-loading i{font-size:3rem;margin-bottom:1rem;opacity:0.3}.notification-empty p{margin:0;font-size:0.9375rem}@media (max-width:768px){.notification-panel{width:calc(100vw - 2rem);right:1rem;top:4.5rem}}
    </style>
    
    <!-- AI Chatbot Widget -->
    {% include 'backend/chatbot_widget.html' %}
</body>
</html>
